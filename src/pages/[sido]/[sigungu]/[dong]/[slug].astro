---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Header from '../../../../components/Header.astro';
import { getCollection } from 'astro:content';
import { getAllEditorials } from '../../../../utils/notion-editorial';
import fs from 'node:fs';
import path from 'node:path';
import { toSlug, extractDong, loadGongdanSigungu, buildGongdanEntries, matchFeeEntry, type GongdanLotEntry } from '../../../../utils/gongdan';

const naverClientId = import.meta.env.PUBLIC_NAVER_MAP_CLIENT_ID;

export async function getStaticPaths() {
  // 노션 에디토리얼 전체 로드
  let editorialMap = new Map<string, any>();
  try {
    const editorials = await getAllEditorials();
    for (const ed of editorials) {
      editorialMap.set(`${ed.district}_${ed.parkingName}`, ed);
    }
  } catch {}

  // ─── 공단주소 기준으로 페이지 생성 ───
  const gongdanDir = path.join(process.cwd(), 'data', '공단주소');
  const paths: any[] = [];
  const sido = '서울특별시';

  if (!fs.existsSync(gongdanDir)) return paths;

  const gongdanFiles = fs.readdirSync(gongdanDir).filter((f: string) => f.endsWith('.json'));

  for (const file of gongdanFiles) {
    const sigungu = file.replace('.json', '');

    const gongdanData = loadGongdanSigungu(sigungu);
    if (!gongdanData) continue;

    // buildGongdanEntries로 전체 lot + slug + dong 생성 (공단주소 데이터만 사용)
    const allEntries = buildGongdanEntries(gongdanData);
    if (allEntries.length === 0) continue;

    // dong별 그룹핑 (dong이 null이면 "기타"로 처리)
    const dongMap = new Map<string, GongdanLotEntry[]>();
    for (const entry of allEntries) {
      const d = entry.dong || '기타';
      if (!dongMap.has(d)) dongMap.set(d, []);
      dongMap.get(d)!.push(entry);
    }

    // 전체 동 목록 (otherDongs prop용)
    const allDongs = [...dongMap.keys()];

    for (const [dong, dongEntries] of dongMap) {
      for (const entry of dongEntries) {
        const lotName = entry.lot.주차장명 || entry.lot.시설명 || '';

        // 같은 동의 다른 주차장 (nearbyEntries prop, 공단주소 기반)
        const nearbyEntries = dongEntries
          .filter(e => e.slug !== entry.slug)
          .slice(0, 5)
          .map(e => ({
            name: e.lot.주차장명 || e.lot.시설명 || '',
            slug: e.slug,
            category: e.category,
            spaces: e.lot.구획수 || e.lot.구획 || e.lot.면수 || null,
            isFree: (e.lot.주차요금 || '').includes('무료'),
            address: e.lot.위치 || e.lot.소재지 || e.lot.주소 || '',
            feeInfo: e.lot.주차요금 || null,
          }));

        // 빌드 시 public/images/parking/{sigungu}/{slug}/ 에서 이미지 로딩
        const imagesDir = path.join(process.cwd(), 'public', 'images', 'parking', sigungu, entry.slug);
        let lotImages: string[] = [];
        if (fs.existsSync(imagesDir)) {
          lotImages = fs.readdirSync(imagesDir)
            .filter((f: string) => /\.(webp|jpg|jpeg|png)$/i.test(f))
            .sort()
            .map((f: string) => `/images/parking/${sigungu}/${entry.slug}/${f}`);
        }

        paths.push({
          params: { sido, sigungu, dong, slug: entry.slug },
          props: {
            item: null,
            nearbyEntries,
            otherDongs: allDongs.filter(d => d !== dong).slice(0, 6),
            matchedLot: entry.lot,
            matchedCategory: entry.category,
            gongdanData,
            editorial: editorialMap.get(`${sigungu}_${lotName}`) || null,
            lotImages,
          },
        });
      }
    }
  }

  return paths;
}

const { sido, sigungu, dong, slug } = Astro.params;
const { item, nearbyEntries, otherDongs, matchedLot, matchedCategory, gongdanData, editorial, lotImages } = Astro.props;

// 매칭된 주차장의 요금정보 찾기
const matchedFee = (() => {
  if (!gongdanData || !matchedLot) return null;
  const lotName = matchedLot.주차장명 || matchedLot.시설명 || '';
  const found = matchFeeEntry(lotName, gongdanData);
  if (found) return found;
  // 주차장 항목 자체에 요금 필드 (송파구, 중구 등)
  const lot = matchedLot;
  if (lot.시간주차요금 || lot.요금 || lot.요금_5분당 || lot.월정기요금 || lot.월정기 || lot.월정기_주간) {
    return lot;
  }
  return null;
})();

// 할인/감면 정보 (구 단위)
const discountInfo = (() => {
  if (!gongdanData) return null;
  if (gongdanData.할인정보 && Array.isArray(gongdanData.할인정보)) {
    if (gongdanData.할인정보.length > 0 && typeof gongdanData.할인정보[0] === 'object') {
      return { type: 'object' as const, items: gongdanData.할인정보 };
    }
    return { type: 'simple' as const, items: gongdanData.할인정보 };
  }
  const nosang = gongdanData.공영주차장?.노상주차장 || gongdanData.노상주차장;
  const nooe = gongdanData.공영주차장?.노외주차장 || gongdanData.노외주차장;
  const src = (typeof nosang === 'object' && !Array.isArray(nosang) ? nosang?.감면정보 : null)
           || (typeof nooe === 'object' && !Array.isArray(nooe) ? nooe?.감면정보 : null);
  if (src && Array.isArray(src)) return { type: 'structured' as const, items: src };
  return null;
})();

// 연락처 정보
const gongdanContact = gongdanData?.연락처 || null;

const displayName = matchedLot?.주차장명 || matchedLot?.시설명 || '주차장';

// 공단주소 기반 표시용 객체
const parsedSpaces = parseInt(String(matchedLot?.구획수 || matchedLot?.구획 || matchedLot?.면수 || '0').replace(/[^0-9]/g, '')) || 0;
const itemForDisplay = {
  name: displayName,
  address: matchedLot?.위치 || matchedLot?.소재지 || matchedLot?.주소 || '',
  roadAddress: matchedLot?.위치 || matchedLot?.소재지 || matchedLot?.주소 || '',
  lat: matchedLot?.lat || null,
  lng: matchedLot?.lng || null,
  totalSpaces: parsedSpaces,
  isFree: (matchedLot?.주차요금 || '').includes('무료'),
  phone: matchedLot?.연락처 || matchedLot?.전화번호 || gongdanData?.대표전화번호 || null,
  type: '공영',
  category: matchedCategory || '',
  weekdayOpen: '',
  weekdayClose: '',
  weekendOpen: '',
  weekendClose: '',
  holidayOpen: '',
  holidayClose: '',
  dong: null,
  nearbyAmenities: [],
  nearbyPOIs: [],
  images: lotImages || [],
};

// ─── 공단주소 기준 핵심 변수 추출 ───
const gongdanAddress = matchedLot?.위치 || matchedLot?.소재지 || matchedLot?.주소 || itemForDisplay.address;
const gongdanSpaces = matchedLot?.구획수 || matchedLot?.구획 || matchedLot?.면수 || matchedLot?.총면수 || null;
const gongdanPhone = matchedLot?.연락처 || matchedLot?.전화번호 || gongdanData?.대표전화번호 || itemForDisplay.phone || null;
const gongdanGrade = matchedLot?.급지 || null;
const gongdanArea = matchedLot?.면적 || null;
const gongdanOrg = gongdanData?.공단명칭 || null;
const gongdanOperation = matchedLot?.운영 || null;
const gongdanHours = matchedLot?.운영시간 || null;
const gongdanHoursWeekday = matchedLot?.운영시간_평일 || null;
const gongdanHoursSaturday = matchedLot?.운영시간_토요일 || null;
const gongdanCollectDate = gongdanData?.수집일시 || null;
const gongdanSource = gongdanData?.데이터출처 || null;

// 운영시간 기반 24시간 판단
const is24h = gongdanHours
  ? gongdanHours.includes('24시간')
  : (itemForDisplay.weekdayOpen === '00:00' && (itemForDisplay.weekdayClose === '00:00' || itemForDisplay.weekdayClose === '23:59'));

// ─── 주변 주차장 (같은 동, 공단주소 기반) ───
const nearbyItems = (nearbyEntries || []);

// ─── SEO 메타 ───
const feeLabel = matchedFee ? (matchedFee.시간주차요금 || matchedFee.시간제 || matchedFee.시간제요금 || matchedFee.요금_5분당 || matchedFee.요금 || '유료') : '유료';
const title = `${displayName} 주차장 요금·운영시간·위치 | ${sigungu} ${dong} ${matchedCategory || '공영'}주차장 | 파킹맵`;
const description = `${sigungu} ${dong} ${displayName} 주차장 완벽 가이드. ${matchedCategory || '공영'} 주차장. 주차면 ${gongdanSpaces || '-'}${is24h ? ', 24시간 운영' : ''}${gongdanGrade ? `, ${gongdanGrade}` : ''}. 주소: ${gongdanAddress}. ${gongdanOrg || sigungu} 관리.`;
const canonical = `https://parkingmap.kr/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(dong!)}/${encodeURIComponent(slug!)}/`;

// ─── 브레드크럼 ───
const breadcrumbs = [
  { name: '홈', url: 'https://parkingmap.kr/' },
  { name: sido!, url: `https://parkingmap.kr/${encodeURIComponent(sido!)}/` },
  { name: sigungu!, url: `https://parkingmap.kr/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/` },
  { name: dong!, url: `https://parkingmap.kr/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(dong!)}/` },
  { name: displayName, url: canonical },
];

// ─── Schema.org: ParkingFacility ───
const parkingSchema = {
  "@context": "https://schema.org",
  "@type": "ParkingFacility",
  "name": displayName,
  "description": `${sigungu} ${dong}에 위치한 ${matchedCategory || '공영'} 주차장. 주차면 ${gongdanSpaces || '정보없음'}.${gongdanGrade ? ` ${gongdanGrade}.` : ''} ${gongdanOrg || sigungu} 관리.`,
  "url": canonical,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": gongdanAddress,
    "addressLocality": sigungu,
    "addressRegion": sido,
    "addressCountry": "KR",
  },
  ...(itemForDisplay.lat && itemForDisplay.lng && {
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": itemForDisplay.lat,
      "longitude": itemForDisplay.lng,
    },
  }),
  ...(gongdanPhone && { "telephone": gongdanPhone }),
  ...(gongdanSpaces && { "maximumAttendeeCapacity": String(gongdanSpaces).replace(/[^0-9]/g, '') }),
  ...(gongdanHours && {
    "openingHours": gongdanHours,
  }),
  ...(matchedFee && {
    "priceRange": feeLabel,
  }),
};

// ─── FAQ 생성 (공단주소 기준) ───
function generateFAQ(itemData: any, gLot: any, gFee: any, gCat: string | null, gAddr: string, gSpaces: string | null, gHrs: string | null, gGrade: string | null, gOrg: string | null, dongName: string, sigunguName: string, nearbyLots: any[] = []) {
  const faqs: { q: string; a: string }[] = [];
  const name = itemData.name;

  // 요금 FAQ
  if (gFee) {
    const feeStr = gFee.시간주차요금 || gFee.시간제 || gFee.시간제요금 || gFee.요금_5분당 || gFee.요금 || '';
    const monthlyStr = gFee.월정기요금 || gFee.월정기 || gFee.주간월정기권 || gFee.전일월정기권 || '';
    faqs.push({
      q: `${name} 주차장 요금은 얼마인가요?`,
      a: `${name} 주차장은 ${sigunguName} ${gOrg || '시설관리공단'} 관리 ${gCat || '공영'} 주차장입니다.${gGrade ? ` ${gGrade} 기준` : ''} 시간주차 요금은 ${feeStr || '공단에 문의'}입니다.${monthlyStr ? ` 월정기권은 ${monthlyStr}입니다.` : ''} 정확한 요금은 ${gOrg || sigunguName + ' 관리공단'}에 문의하시기 바랍니다.`,
    });
  } else {
    faqs.push({
      q: `${name} 주차장 요금은 얼마인가요?`,
      a: `${name} 주차장의 상세 요금은 ${gOrg || sigunguName + ' 관리공단'}에 문의하시기 바랍니다.`,
    });
  }

  // 운영시간 FAQ
  if (gHrs) {
    faqs.push({
      q: `${name} 주차장 운영시간은 어떻게 되나요?`,
      a: gHrs.includes('24시간')
        ? `${name} 주차장은 24시간 운영됩니다. 심야 시간이나 이른 아침에도 이용 가능합니다.`
        : `${name} 주차장의 운영시간은 ${gHrs}입니다.`,
    });
  } else if (itemData.weekdayOpen && itemData.weekdayClose) {
    const wdClose = itemData.weekdayClose === '00:00' ? '23:59' : itemData.weekdayClose;
    const is24 = itemData.weekdayOpen === '00:00' && (itemData.weekdayClose === '00:00' || itemData.weekdayClose === '23:59');
    faqs.push({
      q: `${name} 주차장 운영시간은 어떻게 되나요?`,
      a: is24
        ? `${name} 주차장은 24시간 운영됩니다.`
        : `${name} 주차장의 평일 운영시간은 ${itemData.weekdayOpen}~${wdClose}입니다.${itemData.weekendOpen ? ` 주말: ${itemData.weekendOpen}~${itemData.weekendClose === '00:00' ? '23:59' : itemData.weekendClose}` : ''}`,
    });
  }

  // 위치 FAQ
  faqs.push({
    q: `${name} 주차장 위치가 어디인가요?`,
    a: `${name} 주차장은 ${gAddr}에 위치해 있습니다. ${sigunguName} ${dongName} 지역에 있으며, 네이버지도나 카카오맵에서 '${name}'을 검색하시면 정확한 길안내를 받으실 수 있습니다.`,
  });

  // 주차면수 FAQ
  if (gSpaces) {
    const spacesNum = parseInt(String(gSpaces).replace(/[^0-9]/g, ''));
    faqs.push({
      q: `${name} 주차장에 주차 자리가 많나요?`,
      a: `${name} 주차장은 총 ${gSpaces}의 주차 공간을 보유하고 있습니다. ${spacesNum >= 200 ? '대형 주차장으로 주차 자리를 비교적 쉽게 찾으실 수 있습니다.' : spacesNum >= 50 ? '중규모 주차장으로 일반적인 상황에서는 주차가 원활합니다.' : '소규모 주차장이므로 혼잡 시간대에는 만차일 수 있습니다.'}`,
    });
  }

  // 급지 FAQ
  if (gGrade) {
    faqs.push({
      q: `${name} 주차장은 몇 급지인가요?`,
      a: `${name} 주차장은 ${sigunguName} 공영주차장 기준 ${gGrade}입니다. 급지에 따라 시간주차 요금과 월정기권 가격이 달라집니다.`,
    });
  }

  // 관리공단 FAQ
  if (gOrg) {
    faqs.push({
      q: `${name} 주차장 관리는 어디서 하나요?`,
      a: `${name} 주차장은 ${gOrg}에서 관리합니다.${gongdanPhone ? ` 문의 전화: ${gongdanPhone}` : ''}`,
    });
  }

  // 네비게이션 검색 FAQ
  faqs.push({
    q: `${name} 주차장은 네비게이션에 뭐라고 검색하면 되나요?`,
    a: `"${name}" 또는 "${gAddr}"로 검색하시면 정확히 안내됩니다. 네이버지도, 카카오맵, 티맵 모두 검색 가능합니다.`,
  });

  // 만차 시 대안 FAQ
  if (nearbyLots && nearbyLots.length > 0) {
    const altList = nearbyLots.slice(0, 3).map((n: any, i: number) =>
      `${i + 1}) ${n.name} (${n.spaces ? n.spaces + '면' : ''})`
    ).join(' ');
    faqs.push({
      q: `${name} 주차장이 만차일 때 근처 대안 주차장은?`,
      a: `${dongName} 인근 대안 주차장: ${altList}. 파킹맵에서 ${sigunguName} ${dongName} 주변 주차장을 비교해보세요.`,
    });
  }

  return faqs;
}

const faqs = generateFAQ(itemForDisplay, matchedLot, matchedFee, matchedCategory, gongdanAddress, gongdanSpaces, gongdanHours, gongdanGrade, gongdanOrg, dong!, sigungu!, nearbyItems);

// Schema.org: FAQPage
const faqSchema = faqs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map(f => ({
    "@type": "Question",
    "name": f.q,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": f.a,
    },
  })),
} : null;

// ─── 파킹맵 점수 계산 ───
function calcScore(lot: any): number {
  let score = 5.0;
  if (lot.isFree) score += 1.5;
  if (lot.weekdayOpen === '00:00' && (lot.weekdayClose === '00:00' || lot.weekdayClose === '23:59')) score += 1.0;
  if (lot.totalSpaces >= 200) score += 1.0;
  else if (lot.totalSpaces >= 50) score += 0.5;
  if (lot.phone) score += 0.3;
  if (lot.roadAddress) score += 0.2;
  if (lot.weekendOpen && lot.weekendClose) score += 0.3;
  if (lot.holidayOpen && lot.holidayClose) score += 0.2;
  if (lot.monthlyPass && lot.monthlyPass > 0) score += 0.3;
  if (lot.basicCharge && lot.basicCharge < 1000) score += 0.2;
  return Math.min(9.8, Math.round(score * 10) / 10);
}

const score = calcScore(itemForDisplay);

// ─── Schema.org: Review ───
const reviewSchema = {
  "@context": "https://schema.org",
  "@type": "Review",
  "author": {
    "@type": "Organization",
    "name": "파킹맵",
  },
  "datePublished": gongdanCollectDate || "2026-02-15",
  "reviewRating": {
    "@type": "Rating",
    "ratingValue": String(score),
    "bestRating": "10",
  },
  "reviewBody": `${sigungu} ${dong}에 위치한 ${matchedCategory || '공영'} 주차장. ${gongdanSpaces ? gongdanSpaces + ' 규모.' : ''} ${is24h ? '24시간 운영.' : ''}${gongdanGrade ? ` ${gongdanGrade}.` : ''} ${gongdanOrg || sigungu} 관리.`,
};

function scoreLabel(s: number): string {
  if (s >= 9.0) return '최고';
  if (s >= 8.0) return '우수';
  if (s >= 7.0) return '좋음';
  if (s >= 6.0) return '보통';
  return '참고';
}

function scoreColor(s: number): string {
  if (s >= 8.0) return 'emerald';
  if (s >= 6.5) return 'blue';
  return 'gray';
}

const scoreLbl = scoreLabel(score);
const scoreClr = scoreColor(score);

// ─── "이 주차장이 맞는 분" 태그 ───
function getMatchTags(lot: any): string[] {
  const tags: string[] = [];
  if (lot.isFree) tags.push('주차비 절약하고 싶은 분');
  if (lot.weekdayOpen === '00:00' && (lot.weekdayClose === '00:00' || lot.weekdayClose === '23:59')) tags.push('심야·새벽 주차가 필요한 분');
  if (lot.totalSpaces >= 200) tags.push('넓은 주차장을 선호하는 분');
  if (lot.totalSpaces && lot.totalSpaces < 30) tags.push('소규모 조용한 주차장을 원하는 분');
  if (lot.monthlyPass && lot.monthlyPass > 0) tags.push('월정기 주차가 필요한 분');
  if (lot.operatingDays && lot.operatingDays.includes('공휴일')) tags.push('공휴일에도 주차해야 하는 분');
  if (lot.type === '공영') tags.push('공영주차장을 찾는 분');
  if (lot.category === '노상') tags.push('잠깐 볼일 볼 때');
  if (lot.category === '노외') tags.push('장시간 주차에 적합');
  return tags.slice(0, 4);
}

const matchTags = getMatchTags(itemForDisplay);

// ─── 에디터 리뷰 (강화) ───
function generateReview(lot: any, dongName: string, sigunguName: string) {
  const name = lot.name;
  const isFree = lot.isFree;
  const spaces = lot.totalSpaces;
  const type = lot.type || '공영';
  const category = lot.category || '';
  const feeInfo = lot.feeInfo;
  const operatingDays = lot.operatingDays || '';
  const phone = lot.phone;
  const is24 = lot.weekdayOpen === '00:00' && (lot.weekdayClose === '00:00' || lot.weekdayClose === '23:59');

  // 결정론적 해시
  let h = 0;
  for (let i = 0; i < name.length; i++) h = ((h << 5) - h + name.charCodeAt(i)) | 0;
  h = Math.abs(h);

  // 한줄평
  const oneLiner = isFree
    ? (spaces >= 100
      ? '무료에 넓은 주차장, 이런 곳이 있다니.'
      : spaces >= 30
        ? '무료 주차장. 빈자리만 있으면 최고의 선택.'
        : '조용한 무료 주차장. 얼리버드에게 추천.')
    : is24
      ? '24시간 운영. 시간 눈치 안 봐도 됩니다.'
      : spaces >= 100
        ? '규모가 큰 유료 주차장. 자리 걱정은 덜하실 겁니다.'
        : '실용적인 유료 주차장. 가볍게 이용하기 좋습니다.';

  // 상세 리뷰 5가지 패턴
  const intros = [
    `${sigunguName} ${dongName}에서 주차할 곳을 찾고 계시다면, ${name}을(를) 한번 확인해 보시길 권합니다. ${category ? category + ' 형태의 ' : ''}${type} 주차장으로, ${dongName} 일대에서 꽤 알려진 주차 시설입니다.`,
    `${dongName}에 주차 문제로 골머리를 앓고 계셨다면 ${name}이(가) 해답이 될 수 있습니다. ${lot.roadAddress || lot.address} 인근에 위치한 ${type} 주차장으로, 접근성이 좋습니다.`,
    `${name}은(는) ${sigunguName} ${dongName}의 주요 주차 인프라 중 하나입니다. ${category ? category + ' 타입으로 ' : ''}${lot.roadAddress || lot.address}에서 편리하게 이용할 수 있습니다.`,
    `솔직히 ${dongName}에서 주차하기 쉽지 않습니다. 그래서 ${name} 같은 ${type} 주차장의 존재가 반갑습니다. ${lot.roadAddress || lot.address}에 자리잡고 있어 주변 접근이 용이합니다.`,
    `${sigunguName} ${dongName}을(를) 자주 방문하는 분이라면 ${name}을(를) 기억해 두시는 게 좋습니다. 이 지역에서 손꼽히는 ${type} 주차 시설입니다.`,
  ];

  let detail = '';
  if (spaces) {
    if (spaces >= 200) detail += `총 ${spaces}면의 대규모 주차 공간을 갖추고 있어, 웬만한 시간대에는 빈자리를 찾으실 수 있습니다. `;
    else if (spaces >= 100) detail += `${spaces}면 규모로, 일반적인 상황에서는 주차가 원활한 편입니다. `;
    else if (spaces >= 30) detail += `${spaces}면의 주차 공간을 제공합니다. 적당한 규모지만, 피크 타임에는 미리 도착하시는 게 좋습니다. `;
    else detail += `${spaces}면의 소규모 주차장입니다. 혼잡 시간대에는 만차일 수 있으니, 대안 주차장도 미리 파악해 두세요. `;
  }

  if (isFree) {
    detail += `무료로 운영되고 있어 비용 부담 없이 편하게 이용하실 수 있다는 점이 가장 큰 장점입니다. `;
  } else if (lot.basicTime && lot.basicCharge) {
    detail += `요금은 기본 ${lot.basicTime}분에 ${lot.basicCharge.toLocaleString()}원`;
    if (lot.addUnitTime && lot.addUnitCharge) {
      detail += `, 이후 ${lot.addUnitTime}분마다 ${lot.addUnitCharge.toLocaleString()}원이 추가`;
    }
    detail += `됩니다. `;
    if (lot.monthlyPass && lot.monthlyPass > 0) {
      detail += `월정기권(${lot.monthlyPass.toLocaleString()}원)도 있으니, 자주 이용하시는 분은 정기권이 훨씬 경제적입니다. `;
    }
  } else if (feeInfo) {
    detail += `주차 요금은 ${feeInfo}이며, 장기 주차 시 일일 최대 요금이 적용될 수 있습니다. `;
  }

  if (is24) {
    detail += `24시간 연중무휴 운영이라 심야나 이른 아침에도 걱정 없이 이용 가능합니다.`;
  } else if (lot.weekdayOpen && lot.weekdayClose) {
    const close = lot.weekdayClose === '00:00' ? '23:59' : lot.weekdayClose;
    detail += `평일 ${lot.weekdayOpen}~${close} 운영`;
    if (lot.weekendOpen && lot.weekendClose) {
      const wClose = lot.weekendClose === '00:00' ? '23:59' : lot.weekendClose;
      detail += `, 주말 ${lot.weekendOpen}~${wClose}`;
    }
    detail += `입니다.`;
  }

  if (phone) {
    detail += ` 궁금한 점은 ${phone}으로 문의하시면 됩니다.`;
  }

  const tips = [
    `${dongName}을(를) 방문하실 때는 네이버 지도에서 '${name}'을(를) 검색하면 진입로까지 정확하게 안내받으실 수 있습니다. 주차장 진·출입구 위치를 미리 확인해 두면 현장에서 헤매지 않습니다.${operatingDays.includes('공휴일') ? ' 공휴일에도 운영하니 연휴 때도 활용 가능합니다.' : ''}`,
    `출퇴근 시간대(8~9시, 18~19시)와 점심시간(12~13시)에는 주차 수요가 몰립니다. 가능하면 이 시간을 피해 방문하시는 걸 추천드립니다. 만차 시에는 ${dongName} 주변 다른 주차장도 대안으로 검토해 보세요.`,
    `파킹맵에서 ${sigunguName} ${dongName} 주차장을 즐겨찾기 해두시면 다음에 빠르게 찾으실 수 있습니다. 현장 상황은 수시로 변경될 수 있으니, 방문 전 운영 여부를 한 번 더 확인하시길 권합니다.`,
    `${name} 이용 시 주차 후 영수증을 꼭 챙기세요. 인근 상점에서 주차 할인 연계가 되는 경우도 있습니다. 장시간 주차가 예상된다면 요금 비교 후 결정하시는 게 현명합니다.`,
    `내비게이션에 '${lot.roadAddress || lot.address}'를 입력하시면 정확한 위치로 안내됩니다. 주차장 근처에 도착하면 'P' 표지판을 따라가시면 됩니다. 첫 방문이시라면 진입 방향을 미리 확인해 두세요.`,
  ];

  return {
    oneLiner,
    intro: intros[h % 5],
    detail,
    tip: tips[(h + 2) % 5],
  };
}

const review = generateReview(itemForDisplay, dong!, sigungu!);

// ─── Notion 에디토리얼 콘텐츠 ───
const editorialSlug = `${sido}-${sigungu}-${dong}-${slug}`;
const editorialEntries = await getCollection('parking-editorial');
const editorialEntry = editorialEntries.find((e: any) => e.slug === editorialSlug);
let EditorialContent: any = null;
if (editorialEntry) {
  const rendered = await editorialEntry.render();
  EditorialContent = rendered.Content;
}

// ─── 외부 지도 링크 ───
const naverUrl = `https://map.naver.com/p/search/${encodeURIComponent(gongdanAddress)}`;
const kakaoUrl = itemForDisplay.lat && itemForDisplay.lng
  ? `https://map.kakao.com/link/map/${encodeURIComponent(displayName)},${itemForDisplay.lat},${itemForDisplay.lng}`
  : `https://map.kakao.com/link/search/${encodeURIComponent(gongdanAddress)}`;
const tmapUrl = itemForDisplay.lat && itemForDisplay.lng
  ? `https://tmap.life/route?goalname=${encodeURIComponent(displayName)}&goaly=${itemForDisplay.lat}&goalx=${itemForDisplay.lng}`
  : `https://tmap.life/route?goalname=${encodeURIComponent(gongdanAddress)}`;
const googleMapUrl = itemForDisplay.lat && itemForDisplay.lng
  ? `https://www.google.com/maps/search/?api=1&query=${itemForDisplay.lat},${itemForDisplay.lng}&query_place_id=${encodeURIComponent(displayName)}`
  : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(gongdanAddress)}`;

// ─── 시간 포맷 ───
function formatTime(open: string, close: string): string {
  if (!open && !close) return '정보 없음';
  if (open === '00:00' && (close === '00:00' || close === '23:59')) return '24시간';
  return `${open || '-'} ~ ${close || '-'}`;
}

// ─── 이미지 (추후 확장) ───
const images: string[] = itemForDisplay.images || [];
---

<BaseLayout title={title} description={description} canonical={canonical} ogType="place" breadcrumbs={breadcrumbs}>
  <Fragment slot="head">
    <Fragment set:html={`<script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverClientId}"></script>`} />
    <script type="application/ld+json" set:html={JSON.stringify(parkingSchema)} />
    {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
    <script type="application/ld+json" set:html={JSON.stringify(reviewSchema)} />
  </Fragment>

  <Header />

  <!-- ━━━ 브레드크럼 ━━━ -->
  <nav class="flex items-center gap-1.5 text-sm text-gray-400 mb-6 flex-wrap" aria-label="breadcrumb">
    <a href="/" class="hover:text-emerald-600 transition-colors">홈</a>
    <span>/</span>
    <a href={`/${encodeURIComponent(sido!)}/`} class="hover:text-emerald-600 transition-colors">{sido}</a>
    <span>/</span>
    <a href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/`} class="hover:text-emerald-600 transition-colors">{sigungu}</a>
    <span>/</span>
    <a href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(dong!)}/`} class="hover:text-emerald-600 transition-colors">{dong}</a>
    <span>/</span>
    <span class="text-gray-900 font-semibold">{displayName}</span>
  </nav>

  <!-- ━━━ 히어로 섹션 ━━━ -->
  <section class="mb-8">
    <div class="flex items-center gap-3 mb-3 flex-wrap">
      <h1 class="text-3xl md:text-4xl font-black text-gray-900">{displayName}</h1>
      <span class="px-3 py-1 text-sm font-bold rounded-lg bg-blue-100 text-blue-700">
        {matchedCategory || '공영'}
      </span>
      {is24h && (
        <span class="px-3 py-1 text-sm font-bold rounded-lg bg-purple-100 text-purple-700">24시간</span>
      )}
      {gongdanGrade && (
        <span class="px-3 py-1 text-sm font-bold rounded-lg bg-amber-100 text-amber-700">{gongdanGrade}</span>
      )}
      {gongdanOperation && (
        <span class="px-3 py-1 text-sm font-medium rounded-lg bg-gray-100 text-gray-600">{gongdanOperation}</span>
      )}
    </div>
    <p class="text-gray-500 mb-2">{gongdanAddress}</p>
    {gongdanOrg && <p class="text-sm text-gray-400">{gongdanOrg} 관리</p>}
    <p class="text-sm text-gray-400 italic mt-1">"{review.oneLiner}"</p>
  </section>

  <!-- ━━━ 핵심 정보 카드 ━━━ -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8" aria-label="핵심 정보">
    <div class="bg-gray-50 rounded-xl p-4 text-center">
      <p class="text-xs text-gray-400 mb-1">주차면수</p>
      <p class="text-xl font-black text-gray-900">{gongdanSpaces || '-'}</p>
    </div>
    <div class="rounded-xl p-4 text-center bg-blue-50">
      <p class="text-xs mb-1 text-blue-500">요금</p>
      <p class="text-lg font-black text-blue-600">{matchedFee ? (matchedFee.시간주차요금 || matchedFee.시간제 || matchedFee.시간제요금 || matchedFee.요금_5분당 || matchedFee.요금 || '유료') : '공단 문의'}</p>
      {gongdanGrade && <p class="text-xs mt-0.5 text-blue-400">{gongdanGrade}</p>}
    </div>
    <div class="bg-gray-50 rounded-xl p-4 text-center">
      <p class="text-xs text-gray-400 mb-1">운영시간</p>
      <p class="text-lg font-black text-gray-900">{is24h ? '24시간' : (gongdanHours || (itemForDisplay.weekdayOpen && itemForDisplay.weekdayClose ? `${itemForDisplay.weekdayOpen}~${itemForDisplay.weekdayClose === '00:00' ? '23:59' : itemForDisplay.weekdayClose}` : '-'))}</p>
    </div>
    <div class="bg-gray-50 rounded-xl p-4 text-center">
      <p class="text-xs text-gray-400 mb-1">파킹맵 점수</p>
      <p class={`text-xl font-black ${scoreClr === 'emerald' ? 'text-emerald-600' : scoreClr === 'blue' ? 'text-blue-600' : 'text-gray-600'}`}>{score}</p>
      <p class={`text-xs mt-0.5 ${scoreClr === 'emerald' ? 'text-emerald-400' : scoreClr === 'blue' ? 'text-blue-400' : 'text-gray-400'}`}>{scoreLbl}</p>
    </div>
  </section>

  <!-- ━━━ 네이버 지도 ━━━ -->
  <section class="mb-6">
    <h2 class="sr-only">{displayName} 위치 지도</h2>
    <div id="naver-map" class="w-full h-[350px] md:h-[420px] bg-gray-100 rounded-2xl overflow-hidden flex items-center justify-center">
      <p class="text-gray-400">지도를 불러오는 중...</p>
    </div>
  </section>

  <!-- ━━━ 외부 지도 링크 ━━━ -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-10">
    <a href={naverUrl} target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-3 text-sm font-bold text-green-700 bg-green-50 rounded-xl hover:bg-green-100 transition-colors border border-green-200">
      <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      네이버지도
    </a>
    <a href={kakaoUrl} target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-3 text-sm font-bold text-yellow-800 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition-colors border border-yellow-200">
      <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      카카오맵
    </a>
    <a href={tmapUrl} target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-3 text-sm font-bold text-red-700 bg-red-50 rounded-xl hover:bg-red-100 transition-colors border border-red-200">
      <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
      티맵
    </a>
    <a href={googleMapUrl} target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-3 text-sm font-bold text-blue-700 bg-blue-50 rounded-xl hover:bg-blue-100 transition-colors border border-blue-200">
      <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      구글맵
    </a>
  </div>

  <!-- ━━━ 현장 사진 ━━━ -->
  <section class="mb-10">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-9 h-9 bg-blue-500 rounded-full flex items-center justify-center shrink-0">
        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </div>
      <h2 class="text-lg font-bold text-gray-900">현장 사진</h2>
    </div>
    {images.length > 0 ? (
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        {images.map((src, i) => (
          <div class="relative aspect-[4/3] rounded-xl overflow-hidden bg-gray-100">
            <img src={src} alt={`${displayName} 현장 사진 ${i + 1}`} class="w-full h-full object-cover" loading="lazy" />
          </div>
        ))}
      </div>
    ) : (
      <div class="border-2 border-dashed border-gray-200 rounded-2xl p-8 text-center">
        <div class="flex flex-col items-center gap-3">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-400">파킹맵 에디터가 직접 촬영한 사진이 곧 업로드됩니다</p>
            <p class="text-xs text-gray-300 mt-1">입구, 주차 공간, 요금표 등 실제 현장 사진을 제공할 예정입니다</p>
          </div>
        </div>
      </div>
    )}
  </section>

  <!-- ━━━ 파킹맵 에디터 리뷰 ━━━ -->
  <section class="border border-emerald-200 bg-gradient-to-br from-emerald-50/50 to-white rounded-2xl p-6 mb-10">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-9 h-9 bg-emerald-500 rounded-full flex items-center justify-center shrink-0">
        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
      </div>
      <div>
        <span class="text-xs font-bold text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-full">파킹맵 에디터</span>
        <h2 class="text-lg font-bold text-gray-900 mt-0.5">{displayName} 이용 가이드</h2>
      </div>
    </div>
    {editorial?.editorOpinion ? (
      <div class="text-gray-700 text-[15px] leading-relaxed space-y-3 pl-12">
        <p>{editorial.editorOpinion}</p>
      </div>
    ) : EditorialContent ? (
      <div class="prose prose-emerald max-w-none text-gray-700 text-[15px] leading-relaxed pl-12">
        <EditorialContent />
      </div>
    ) : (
      <div class="text-gray-700 text-[15px] leading-relaxed space-y-3 pl-12">
        <p>{review.intro}</p>
        <p>{review.detail}</p>
        <p class="text-gray-500 text-sm border-l-2 border-emerald-200 pl-3 italic">{review.tip}</p>
      </div>
    )}
    <div class="mt-4 pt-3 border-t border-emerald-100 pl-12">
      <p class="text-xs text-gray-400">
        {editorial?.editorOpinion
          ? `파킹맵 에디터가 직접 작성한 리뷰입니다 (${editorial.updatedAt || ''}). 현장 상황과 다를 수 있으니 방문 전 확인을 권장합니다.`
          : EditorialContent
            ? '파킹맵 에디터가 직접 작성한 리뷰입니다. 현장 상황과 다를 수 있으니 방문 전 확인을 권장합니다.'
            : `${gongdanOrg || sigungu + ' 시설관리공단'} 홈페이지 직접 조사 기반 파킹맵 에디터 작성. 현장 상황과 다를 수 있으니 방문 전 확인을 권장합니다.`}
      </p>
    </div>
  </section>

  <!-- ━━━ 이 주차장이 맞는 분 ━━━ -->
  {matchTags.length > 0 && (
    <section class="mb-10">
      <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-violet-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        이런 분에게 추천합니다
      </h2>
      <div class="flex flex-wrap gap-2">
        {matchTags.map((tag) => (
          <span class="inline-flex items-center gap-1.5 px-4 py-2 bg-violet-50 text-violet-700 text-sm font-medium rounded-full border border-violet-100">
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
            {tag}
          </span>
        ))}
      </div>
    </section>
  )}

  <!-- ━━━ 기본 정보 ━━━ -->
  <section class="border border-gray-200 rounded-2xl p-5 mb-4">
    <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      기본 정보
    </h2>
    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-6">
      <div class="flex gap-3">
        <dt class="text-sm text-gray-400 w-20 shrink-0">주소</dt>
        <dd class="text-sm text-gray-900 font-medium">{gongdanAddress}</dd>
      </div>
      <div class="flex gap-3">
        <dt class="text-sm text-gray-400 w-20 shrink-0">유형</dt>
        <dd class="text-sm text-gray-900 font-medium">{matchedCategory || '공영'}</dd>
      </div>
      {gongdanSpaces && (
        <div class="flex gap-3">
          <dt class="text-sm text-gray-400 w-20 shrink-0">구획수</dt>
          <dd class="text-sm text-gray-900 font-medium">{gongdanSpaces}</dd>
        </div>
      )}
      {gongdanGrade && (
        <div class="flex gap-3">
          <dt class="text-sm text-gray-400 w-20 shrink-0">급지</dt>
          <dd class="text-sm text-gray-900 font-medium">
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-md bg-amber-50 text-amber-700 border border-amber-200">{gongdanGrade}</span>
          </dd>
        </div>
      )}
      {gongdanArea && (
        <div class="flex gap-3">
          <dt class="text-sm text-gray-400 w-20 shrink-0">면적</dt>
          <dd class="text-sm text-gray-900 font-medium">{gongdanArea}</dd>
        </div>
      )}
      {gongdanPhone && (
        <div class="flex gap-3">
          <dt class="text-sm text-gray-400 w-20 shrink-0">전화번호</dt>
          <dd class="text-sm text-gray-900 font-medium">
            <a href={`tel:${gongdanPhone}`} class="text-emerald-600 hover:underline">{gongdanPhone}</a>
          </dd>
        </div>
      )}
      {gongdanOperation && (
        <div class="flex gap-3">
          <dt class="text-sm text-gray-400 w-20 shrink-0">운영방식</dt>
          <dd class="text-sm text-gray-900 font-medium">{gongdanOperation}</dd>
        </div>
      )}
      {gongdanOrg && (
        <div class="flex gap-3">
          <dt class="text-sm text-gray-400 w-20 shrink-0">관리공단</dt>
          <dd class="text-sm text-gray-900 font-medium">{gongdanOrg}</dd>
        </div>
      )}
      {gongdanCollectDate && (
        <div class="flex gap-3">
          <dt class="text-sm text-gray-400 w-20 shrink-0">데이터기준</dt>
          <dd class="text-sm text-gray-900 font-medium">{gongdanCollectDate}</dd>
        </div>
      )}
    </dl>
  </section>


  <!-- ━━━ 주변 편의시설 ━━━ -->
  {itemForDisplay.nearbyAmenities && itemForDisplay.nearbyAmenities.length > 0 && (
    <section class="border border-gray-200 rounded-2xl p-5 mb-4">
      <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
        주변 편의시설
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
        {itemForDisplay.nearbyAmenities.map((a: any) => (
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center shrink-0">
              <span class="text-teal-700 text-xs font-black">{a.walkMin}분</span>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-900">{a.name}</p>
              <p class="text-xs text-gray-400">{a.category} · 도보 {a.walkMin}분</p>
            </div>
          </div>
        ))}
      </div>
      <p class="text-xs text-gray-400 mt-3 text-center">도보 시간은 일반 성인 보행 속도(분당 약 70~80m) 기준 예상치입니다</p>
    </section>
  )}

  <!-- ━━━ 운영 시간 ━━━ -->
  <section class="border border-gray-200 rounded-2xl p-5 mb-4">
    <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      운영 시간
    </h2>
    {gongdanHours ? (
      <div class="bg-gray-50 rounded-xl p-4 text-center">
        <p class="text-sm font-bold text-gray-900">{gongdanHours}</p>
      </div>
    ) : gongdanHoursWeekday ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="bg-gray-50 rounded-xl p-4 text-center">
          <p class="text-xs text-gray-400 mb-1">평일</p>
          <p class="text-sm font-bold text-gray-900">{gongdanHoursWeekday}</p>
        </div>
        {gongdanHoursSaturday && (
          <div class="bg-gray-50 rounded-xl p-4 text-center">
            <p class="text-xs text-gray-400 mb-1">토요일</p>
            <p class="text-sm font-bold text-gray-900">{gongdanHoursSaturday}</p>
          </div>
        )}
      </div>
    ) : (
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="bg-gray-50 rounded-xl p-4 text-center">
          <p class="text-xs text-gray-400 mb-1">평일 (월~금)</p>
          <p class="text-sm font-bold text-gray-900">{formatTime(itemForDisplay.weekdayOpen, itemForDisplay.weekdayClose)}</p>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 text-center">
          <p class="text-xs text-gray-400 mb-1">토요일</p>
          <p class="text-sm font-bold text-gray-900">{formatTime(itemForDisplay.weekendOpen, itemForDisplay.weekendClose)}</p>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 text-center">
          <p class="text-xs text-gray-400 mb-1">공휴일</p>
          <p class="text-sm font-bold text-gray-900">{formatTime(itemForDisplay.holidayOpen, itemForDisplay.holidayClose)}</p>
        </div>
      </div>
    )}
  </section>

  <!-- ━━━ 요금 정보 ━━━ -->
  <section class="border border-gray-200 rounded-2xl p-5 mb-10">
    <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      요금 정보
      {gongdanGrade && <span class="text-xs font-medium text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full ml-2">{gongdanGrade}</span>}
    </h2>

    {matchedFee ? (
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
        {(matchedFee.시간주차요금 || matchedFee.시간제 || matchedFee.시간제요금) && (
          <div class="bg-amber-50 rounded-xl p-4 text-center">
            <p class="text-xs text-amber-500 mb-1">시간주차</p>
            <p class="text-sm font-bold text-amber-700">{matchedFee.시간주차요금 || matchedFee.시간제 || matchedFee.시간제요금}</p>
          </div>
        )}
        {matchedFee.요금_5분당 && (
          <div class="bg-amber-50 rounded-xl p-4 text-center">
            <p class="text-xs text-amber-500 mb-1">5분당 요금</p>
            <p class="text-sm font-bold text-amber-700">{matchedFee.요금_5분당}</p>
          </div>
        )}
        {matchedFee.요금 && !matchedFee.시간주차요금 && !matchedFee.요금_5분당 && (
          <div class="bg-amber-50 rounded-xl p-4 text-center">
            <p class="text-xs text-amber-500 mb-1">요금</p>
            <p class="text-sm font-bold text-amber-700">{matchedFee.요금}</p>
          </div>
        )}
        {(matchedFee.월정기요금 || matchedFee.월정기) && (
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <p class="text-xs text-blue-400 mb-1">월정기권</p>
            <p class="text-sm font-bold text-blue-700">{matchedFee.월정기요금 || matchedFee.월정기}</p>
          </div>
        )}
        {matchedFee.월정기_주간 && (
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <p class="text-xs text-blue-400 mb-1">월정기 (주간)</p>
            <p class="text-sm font-bold text-blue-700">{matchedFee.월정기_주간}</p>
          </div>
        )}
        {matchedFee.월정기_야간 && (
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <p class="text-xs text-blue-400 mb-1">월정기 (야간)</p>
            <p class="text-sm font-bold text-blue-700">{matchedFee.월정기_야간}</p>
          </div>
        )}
        {matchedFee.주간월정기권 && (
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <p class="text-xs text-blue-400 mb-1">월정기 (주간)</p>
            <p class="text-sm font-bold text-blue-700">{matchedFee.주간월정기권}</p>
          </div>
        )}
        {matchedFee.야간월정기권 && (
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <p class="text-xs text-blue-400 mb-1">월정기 (야간)</p>
            <p class="text-sm font-bold text-blue-700">{matchedFee.야간월정기권}</p>
          </div>
        )}
        {matchedFee.전일월정기권 && (
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <p class="text-xs text-blue-400 mb-1">월정기 (전일)</p>
            <p class="text-sm font-bold text-blue-700">{matchedFee.전일월정기권}</p>
          </div>
        )}
        {matchedFee.월정기권 && (
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <p class="text-xs text-blue-400 mb-1">월정기권</p>
            <p class="text-sm font-bold text-blue-700">{matchedFee.월정기권}</p>
          </div>
        )}
      </div>
    ) : (
      <div class="bg-gray-50 rounded-xl p-5 text-center">
        <p class="text-gray-500">요금 정보는 {gongdanOrg || sigungu + ' 관리공단'}에 문의해주세요</p>
        {gongdanPhone && <p class="text-sm text-emerald-600 mt-1"><a href={`tel:${gongdanPhone}`}>{gongdanPhone}</a></p>}
      </div>
    )}
    <p class="text-xs text-gray-400 mt-3">* {gongdanOrg || sigungu + ' 시설관리공단'} 기준 요금이며, 실제와 다를 수 있습니다</p>
  </section>

  {/* ━━━ 할인/감면 정보 (공단주소) ━━━ */}
  {discountInfo && (
    <section class="border border-gray-200 rounded-2xl p-5 mb-4">
      <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
        {sigungu} 공영주차장 할인/감면 정보
      </h2>

      {discountInfo.type === 'simple' && (
        <ul class="space-y-2">
          {discountInfo.items.map((item: string) => (
            <li class="flex items-start gap-2 text-sm text-gray-700">
              <svg class="w-4 h-4 text-rose-400 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              {item}
            </li>
          ))}
        </ul>
      )}

      {discountInfo.type === 'object' && (
        <div class="space-y-2">
          {discountInfo.items.map((d: any) => (
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
              <span class={`px-2 py-0.5 text-xs font-bold rounded-md shrink-0 ${
                String(d.감면율 || d.할인율 || '').includes('면제') || String(d.감면율 || d.할인율 || '').includes('100') ? 'bg-purple-100 text-purple-700' :
                String(d.감면율 || d.할인율 || '').includes('80') ? 'bg-rose-100 text-rose-700' :
                String(d.감면율 || d.할인율 || '').includes('50') ? 'bg-amber-100 text-amber-700' :
                'bg-sky-100 text-sky-700'
              }`}>
                {d.감면율 || d.할인율 || d.감면 || '-'}
              </span>
              <div>
                <p class="text-sm font-medium text-gray-900">{d.대상 || d.감면대상 || d.항목 || ''}</p>
                {(d.기준 || d.비고) && <p class="text-xs text-gray-400 mt-0.5">{d.기준 || d.비고}</p>}
              </div>
            </div>
          ))}
        </div>
      )}

      {discountInfo.type === 'structured' && (
        <div class="space-y-2">
          {discountInfo.items.map((d: any) => (
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
              {d.구분 && (
                <span class="px-2 py-0.5 text-xs font-bold rounded-md bg-rose-100 text-rose-700 shrink-0">{d.구분}</span>
              )}
              <div>
                <p class="text-sm font-medium text-gray-900">{d.감면대상 || d.대상 || ''}</p>
                {d.비고 && <p class="text-xs text-gray-400 mt-0.5">{d.비고}</p>}
              </div>
            </div>
          ))}
        </div>
      )}

      <p class="text-xs text-gray-400 mt-3 border-t border-gray-100 pt-3">
        {sigungu} 공영주차장 공통 할인/감면 기준입니다. 개별 주차장 적용 여부는 현장에서 확인하세요.
      </p>
    </section>
  )}

  <!-- ━━━ 주변 시설 도보 접근 ━━━ -->
  {itemForDisplay.nearbyPOIs && itemForDisplay.nearbyPOIs.length > 0 && (
    <section class="mb-10">
      <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
        주차 후 도보 접근 가능한 주요 시설
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {itemForDisplay.nearbyPOIs.map((poi: any) => (
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <div class="w-10 h-10 bg-cyan-100 rounded-full flex items-center justify-center shrink-0">
              <span class="text-cyan-600 text-sm font-bold">{poi.walkMin || '?'}분</span>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-900">{poi.name}</p>
              <p class="text-xs text-gray-400">{poi.category || ''}{poi.distance ? ` · ${poi.distance}` : ''}</p>
            </div>
          </div>
        ))}
      </div>
      <p class="text-xs text-gray-400 mt-3">도보 시간은 직선거리 기준 예상치이며, 실제 경로에 따라 다를 수 있습니다.</p>
    </section>
  )}

  <!-- ━━━ 자주 묻는 질문 (FAQ) ━━━ -->
  {faqs.length > 0 && (
    <section class="mb-10">
      <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        {displayName} 자주 묻는 질문
      </h2>
      <div class="space-y-3">
        {faqs.map((faq, idx) => (
          <details class="group border border-gray-200 rounded-xl overflow-hidden" open={idx === 0}>
            <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50 transition-colors">
              <span class="font-semibold text-gray-900 text-sm pr-4">{faq.q}</span>
              <svg class="w-5 h-5 text-gray-400 shrink-0 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </summary>
            <div class="px-4 pb-4 text-sm text-gray-600 leading-relaxed border-t border-gray-100 pt-3">
              {faq.a}
            </div>
          </details>
        ))}
      </div>
    </section>
  )}

  <!-- ━━━ 주변 주차장 ━━━ -->
  {nearbyItems.length > 0 && (
    <section class="mb-10">
      <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        {dong} 주변 다른 주차장
      </h2>

      {/* 비교표 (데스크탑) */}
      <div class="hidden sm:block overflow-x-auto mb-4">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200 text-left">
              <th class="py-2 pr-4 text-gray-400 font-medium">주차장명</th>
              <th class="py-2 px-3 text-gray-400 font-medium text-center">요금</th>
              <th class="py-2 px-3 text-gray-400 font-medium text-center">주차면</th>
              <th class="py-2 px-3 text-gray-400 font-medium text-center">유형</th>
              <th class="py-2 pl-3 text-gray-400 font-medium"></th>
            </tr>
          </thead>
          <tbody>
            {nearbyItems.map((nearby: any) => (
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                  <td class="py-3 pr-4">
                    <a href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(dong!)}/${encodeURIComponent(nearby.slug)}/`} class="font-semibold text-gray-900 hover:text-emerald-600 transition-colors">
                      {nearby.name}
                    </a>
                  </td>
                  <td class="py-3 px-3 text-center">
                    <span class={`px-2 py-0.5 text-xs font-semibold rounded ${nearby.isFree ? 'bg-emerald-50 text-emerald-600' : 'bg-blue-50 text-blue-600'}`}>
                      {nearby.isFree ? '무료' : (nearby.feeInfo || '유료')}
                    </span>
                  </td>
                  <td class="py-3 px-3 text-center text-gray-600">{nearby.spaces ? `${nearby.spaces}면` : '-'}</td>
                  <td class="py-3 px-3 text-center text-gray-500 text-xs">{nearby.category || ''}</td>
                  <td class="py-3 pl-3 text-right">
                    <a href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(dong!)}/${encodeURIComponent(nearby.slug)}/`} class="text-emerald-600 text-xs font-semibold hover:underline">
                      상세보기
                    </a>
                  </td>
                </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 카드 목록 (모바일) */}
      <div class="sm:hidden flex flex-col gap-3">
        {nearbyItems.map((nearby: any) => (
            <a
              href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(dong!)}/${encodeURIComponent(nearby.slug)}/`}
              class="flex items-center justify-between p-4 border border-gray-200 rounded-xl hover:border-emerald-200 hover:shadow-sm transition-all"
            >
              <div class="flex items-center gap-3">
                <span class={`w-2 h-2 rounded-full shrink-0 ${nearby.isFree ? 'bg-emerald-500' : 'bg-blue-500'}`}></span>
                <div>
                  <p class="font-bold text-gray-900 text-sm">{nearby.name}</p>
                  <p class="text-xs text-gray-400">{nearby.isFree ? '무료' : (nearby.feeInfo || '유료')}{nearby.spaces ? ` · ${nearby.spaces}면` : ''}</p>
                </div>
              </div>
              <svg class="w-4 h-4 text-gray-300 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </a>
        ))}
      </div>
    </section>
  )}

  <!-- ━━━ 내부 링크: 동/구 탐색 ━━━ -->
  <section class="mb-10">
    <div class="flex gap-3 mb-4">
      <a
        href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(dong!)}/`}
        class="flex-1 text-center px-5 py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-colors text-sm"
      >
        {dong} 전체 주차장 보기
      </a>
      <a
        href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/`}
        class="flex-1 text-center px-5 py-3 bg-emerald-50 text-emerald-700 font-semibold rounded-xl hover:bg-emerald-100 transition-colors text-sm"
      >
        {sigungu} 전체 주차장 보기
      </a>
    </div>

    {otherDongs.length > 0 && (
      <div>
        <h3 class="text-sm font-bold text-gray-500 mb-2">{sigungu} 다른 지역 주차장</h3>
        <div class="flex flex-wrap gap-2">
          {otherDongs.map((d: string) => (
            <a
              href={`/${encodeURIComponent(sido!)}/${encodeURIComponent(sigungu!)}/${encodeURIComponent(d)}/`}
              class="px-3 py-1.5 text-sm text-gray-600 bg-gray-50 rounded-lg hover:bg-emerald-50 hover:text-emerald-700 transition-colors border border-gray-100"
            >
              {d}
            </a>
          ))}
        </div>
      </div>
    )}
  </section>

  {/* ━━━ 관리공단 연락처 ━━━ */}
  {gongdanContact && (
    <section class="border border-gray-200 rounded-2xl p-5 mb-4">
      <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
        {gongdanData?.공단명칭 || `${sigungu} 관리공단`} 안내
      </h2>
      <dl class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-6">
        {gongdanContact.대표전화 && (
          <div class="flex gap-3">
            <dt class="text-sm text-gray-400 w-20 shrink-0">대표전화</dt>
            <dd class="text-sm text-gray-900 font-medium">
              <a href={`tel:${gongdanContact.대표전화}`} class="text-emerald-600 hover:underline">{gongdanContact.대표전화}</a>
            </dd>
          </div>
        )}
        {gongdanContact.주차관련전화 && (
          <div class="flex gap-3">
            <dt class="text-sm text-gray-400 w-20 shrink-0">주차문의</dt>
            <dd class="text-sm text-gray-900 font-medium">
              <a href={`tel:${gongdanContact.주차관련전화}`} class="text-emerald-600 hover:underline">{gongdanContact.주차관련전화}</a>
            </dd>
          </div>
        )}
        {gongdanContact.홈페이지 && (
          <div class="flex gap-3">
            <dt class="text-sm text-gray-400 w-20 shrink-0">홈페이지</dt>
            <dd class="text-sm text-gray-900 font-medium">
              <a href={gongdanContact.홈페이지} target="_blank" rel="noopener noreferrer" class="text-emerald-600 hover:underline">바로가기 ↗</a>
            </dd>
          </div>
        )}
        {gongdanContact.주차포탈 && (
          <div class="flex gap-3">
            <dt class="text-sm text-gray-400 w-20 shrink-0">주차포탈</dt>
            <dd class="text-sm text-gray-900 font-medium">
              <a href={gongdanContact.주차포탈} target="_blank" rel="noopener noreferrer" class="text-emerald-600 hover:underline">바로가기 ↗</a>
            </dd>
          </div>
        )}
        {gongdanContact.주소 && (
          <div class="flex gap-3">
            <dt class="text-sm text-gray-400 w-20 shrink-0">주소</dt>
            <dd class="text-sm text-gray-900 font-medium">{gongdanContact.주소}</dd>
          </div>
        )}
      </dl>
    </section>
  )}

  <!-- ━━━ 데이터 출처 + 신뢰도 표시 ━━━ -->
  <footer class="bg-gray-50 rounded-2xl p-6 mb-4">
    <div class="flex items-center gap-2 mb-3">
      <svg class="w-4 h-4 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
      <span class="text-sm font-bold text-gray-700">데이터 출처</span>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-gray-500 mb-4">
      {gongdanOrg && (
        <div class="flex items-start gap-2">
          <span class="text-gray-400 w-20 shrink-0">관리공단</span>
          <span class="font-medium text-gray-700">{gongdanOrg}</span>
        </div>
      )}
      {gongdanSource && (
        <div class="flex items-start gap-2">
          <span class="text-gray-400 w-20 shrink-0">데이터 출처</span>
          <span><a href={gongdanSource} target="_blank" rel="noopener" class="text-emerald-600 underline hover:text-emerald-700">{gongdanOrg || sigungu} 홈페이지</a></span>
        </div>
      )}
      {gongdanCollectDate && (
        <div class="flex items-start gap-2">
          <span class="text-gray-400 w-20 shrink-0">수집일시</span>
          <span>{gongdanCollectDate}</span>
        </div>
      )}
      <div class="flex items-start gap-2">
        <span class="text-gray-400 w-20 shrink-0">작성</span>
        <span>파킹맵 에디터</span>
      </div>
      {gongdanPhone && (
        <div class="flex items-start gap-2">
          <span class="text-gray-400 w-20 shrink-0">문의전화</span>
          <span><a href={`tel:${gongdanPhone}`} class="text-emerald-600 underline hover:text-emerald-700">{gongdanPhone}</a></span>
        </div>
      )}
    </div>
    <div class="border-t border-gray-200 pt-3 flex flex-col sm:flex-row items-center justify-between gap-2">
      <p class="text-xs text-gray-400">실제 운영 상황과 다를 수 있으니 방문 전 확인을 권장합니다</p>
      <a
        href={`mailto:info@parkingmap.kr?subject=${encodeURIComponent(`[정보수정] ${displayName} 주차장`)}&body=${encodeURIComponent(`주차장명: ${displayName}\n주소: ${gongdanAddress}\n\n수정 내용:\n`)}`}
        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-gray-500 bg-white border border-gray-200 rounded-lg hover:border-emerald-300 hover:text-emerald-600 transition-colors"
      >
        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
        정보 수정 제안
      </a>
    </div>
  </footer>

  <!-- ━━━ 네이버 지도 스크립트 ━━━ -->
  <script define:vars={{ mapItem: JSON.parse(JSON.stringify({ lat: itemForDisplay.lat, lng: itemForDisplay.lng, name: displayName, address: gongdanAddress, isFree: itemForDisplay.isFree })) }}>
    function initDetailMap() {
      if (!mapItem.lat || !mapItem.lng) {
        document.getElementById('naver-map').innerHTML = '<p class="text-gray-400 text-sm">좌표 정보가 없어 지도를 표시할 수 없습니다. 외부 지도 링크를 이용해주세요.</p>';
        return;
      }

      if (typeof naver === 'undefined' || !naver.maps) {
        document.getElementById('naver-map').innerHTML = '<p class="text-gray-400">네이버 지도를 불러올 수 없습니다</p>';
        return;
      }

      var position = new naver.maps.LatLng(mapItem.lat, mapItem.lng);
      var color = mapItem.isFree ? '#10b981' : '#3b82f6';

      var map = new naver.maps.Map('naver-map', {
        center: position,
        zoom: 16,
        mapTypeControl: false,
        zoomControlOptions: { position: naver.maps.Position.TOP_RIGHT },
      });

      var marker = new naver.maps.Marker({
        position: position,
        map: map,
        icon: {
          content: '<div style="width:48px;height:48px;background:' + color + ';border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:20px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);">P</div>',
          anchor: new naver.maps.Point(24, 24),
        },
      });

      var infoWindow = new naver.maps.InfoWindow({
        content: '<div style="padding:12px 16px;min-width:200px;font-size:13px;line-height:1.5;">' +
          '<strong style="font-size:14px;">' + mapItem.name + '</strong><br>' +
          '<span style="color:#666;">' + mapItem.address + '</span>' +
          '</div>',
        borderWidth: 0,
        borderColor: 'transparent',
        backgroundColor: 'white',
        anchorSize: new naver.maps.Size(10, 10),
        pixelOffset: new naver.maps.Point(0, -4),
      });

      infoWindow.open(map, marker);

      naver.maps.Event.addListener(marker, 'click', function() {
        if (infoWindow.getMap()) {
          infoWindow.close();
        } else {
          infoWindow.open(map, marker);
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() { initDetailMap(); });
    } else {
      setTimeout(function() { initDetailMap(); }, 100);
    }
  </script>
</BaseLayout>
