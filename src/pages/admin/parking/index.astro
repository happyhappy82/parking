---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>ì£¼ì°¨ì¥ ê´€ë¦¬ | ParkingMap Admin</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f1f5f9;color:#1e293b;-webkit-font-smoothing:antialiased}

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar{position:fixed;top:0;left:0;width:220px;height:100vh;background:#0f172a;display:flex;flex-direction:column;z-index:50}
    .sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,.06)}
    .sidebar-logo{font-size:15px;font-weight:800;color:#e2e8f0;display:flex;align-items:center;gap:10px;text-decoration:none}
    .logo-icon{width:30px;height:30px;background:linear-gradient(135deg,#10b981,#059669);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:15px}
    .sidebar nav{flex:1;padding:16px 0}
    .sidebar nav a{display:flex;align-items:center;gap:10px;padding:10px 16px;margin:2px 8px;color:#94a3b8;text-decoration:none;font-size:13px;font-weight:500;border-radius:8px;transition:all .15s}
    .sidebar nav a:hover{color:#e2e8f0;background:rgba(255,255,255,.05)}
    .sidebar nav a.active{color:white;background:rgba(16,185,129,.15)}
    .nav-icon{font-size:16px;width:20px;text-align:center}
    .sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.06)}
    .logout-btn{width:100%;padding:8px 12px;background:transparent;border:1px solid rgba(255,255,255,.1);color:#64748b;border-radius:6px;font-size:12px;cursor:pointer;transition:all .15s}
    .logout-btn:hover{background:rgba(255,255,255,.05);color:#94a3b8}

    /* â”€â”€ Main â”€â”€ */
    .main{margin-left:220px;padding:28px 32px;min-height:100vh}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .page-header h1{font-size:22px;font-weight:800;color:#0f172a}
    .page-header .subtitle{font-size:13px;color:#64748b;margin-top:2px}

    /* â”€â”€ Controls â”€â”€ */
    .controls{background:white;border-radius:12px;padding:16px 20px;border:1px solid #e2e8f0;margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls input[type="text"]{flex:1;min-width:200px;padding:9px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;outline:none;transition:border .15s;background:white;color:#1e293b}
    .controls input[type="text"]:focus{border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.1)}
    .controls select{padding:9px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;outline:none;cursor:pointer;background:white;color:#1e293b;transition:border .15s}
    .controls select:focus{border-color:#10b981}

    /* â”€â”€ Table (Google Sheets ìŠ¤íƒ€ì¼) â”€â”€ */
    .table-card{background:white;border-radius:8px;overflow:hidden;border:1px solid #c0c0c0}
    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;padding:8px 12px;font-size:12px;font-weight:600;color:#444;background:#f3f3f3;border-bottom:2px solid #c0c0c0;border-right:1px solid #e0e0e0;white-space:nowrap}
    thead th:last-child{border-right:none}
    tbody td{padding:8px 12px;font-size:13px;border-bottom:1px solid #e0e0e0;border-right:1px solid #e8e8e8;vertical-align:middle}
    tbody td:last-child{border-right:none}
    tbody tr{cursor:pointer;transition:background .12s}
    tbody tr:hover{background:#e8f0fe}
    tbody tr:last-child td{border-bottom:none}
    .badge{display:inline-block;padding:2px 8px;border-radius:5px;font-size:10px;font-weight:700;letter-spacing:.02em}
    .badge-ê³µì˜{background:#ecfdf5;color:#059669}
    .badge-ë¯¼ì˜{background:#dbeafe;color:#2563eb}
    .parking-name{font-weight:600;color:#0f172a}
    .parking-addr{font-size:11px;color:#94a3b8;margin-top:2px;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .loading{text-align:center;padding:60px;color:#94a3b8;font-size:14px}
    .empty{text-align:center;padding:60px;color:#94a3b8;font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;text-decoration:none;white-space:nowrap}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:#10b981;color:white}
    .btn-primary:hover{background:#059669}
    .btn-gray{background:#e2e8f0;color:#475569}
    .btn-gray:hover{background:#cbd5e1}
    .btn-view{background:#f1f5f9;color:#475569;padding:4px 10px;font-size:11px;border:1px solid #e2e8f0;border-radius:6px}
    .btn-view:hover{background:#e2e8f0}
    .td-actions{display:flex;gap:6px;align-items:center}

    /* â”€â”€ Modal â”€â”€ */
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,23,42,.5);z-index:100;backdrop-filter:blur(2px)}
    .modal{position:fixed;top:3%;left:50%;transform:translateX(-50%);width:92%;max-width:860px;max-height:94vh;background:white;border-radius:16px;z-index:101;display:flex;flex-direction:column;box-shadow:0 25px 60px rgba(0,0,0,.15)}
    .modal-header{padding:18px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{font-size:17px;font-weight:800;color:#0f172a}
    .modal-header .header-sub{font-size:11px;color:#94a3b8;margin-top:2px;font-family:'SF Mono','Fira Code',monospace}

    /* â”€â”€ Modal Tabs â”€â”€ */
    .modal-tabs{display:flex;gap:0;border-bottom:1px solid #e2e8f0;padding:0 24px;background:#f8fafc}
    .modal-tab{padding:11px 18px;border:none;background:none;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;position:relative;transition:color .15s}
    .modal-tab:hover{color:#1e293b}
    .modal-tab.active{color:#10b981}
    .modal-tab.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:#10b981}
    .tab-count{display:inline-block;margin-left:5px;padding:1px 7px;border-radius:10px;font-size:10px;font-weight:700;background:rgba(100,116,139,.12);color:#64748b}
    .modal-tab.active .tab-count{background:rgba(16,185,129,.12);color:#10b981}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* â”€â”€ Modal Body â”€â”€ */
    .modal-body{padding:0;overflow-y:auto;flex:1}
    .modal-body .tab-panel{padding:20px 24px}
    .modal-footer{padding:14px 24px;border-top:1px solid #e2e8f0;display:flex;gap:10px;justify-content:flex-end}

    /* â”€â”€ Form Section â”€â”€ */
    .form-section{margin-bottom:20px}
    .form-section-title{font-size:12px;font-weight:700;color:#10b981;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;gap:6px}
    .form-section-title span{font-size:14px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px}
    .form-group{margin-bottom:10px}
    .form-group label{display:block;font-size:11px;font-weight:600;color:#64748b;margin-bottom:4px;letter-spacing:.02em}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:8px 10px;border:1px solid #e2e8f0;border-radius:7px;font-size:13px;color:#1e293b;outline:none;font-family:inherit;transition:all .15s;background:white}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.08)}
    .form-group input[readonly]{background:#f8fafc;color:#94a3b8;cursor:not-allowed}
    .form-group textarea{min-height:100px;resize:vertical;font-family:'SF Mono','Fira Code',monospace;font-size:12px;line-height:1.5}
    .form-group select{cursor:pointer}
    .msg{padding:10px 14px;border-radius:8px;font-size:13px;margin-top:10px;display:none}
    .msg-success{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .msg-error{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}

    /* â”€â”€ Photo Management â”€â”€ */
    .photo-drop{border:2px dashed #d1d5db;border-radius:12px;padding:36px 20px;text-align:center;cursor:pointer;transition:all .2s;background:#fafafa;margin-bottom:14px}
    .photo-drop:hover,.photo-drop.dragover{border-color:#10b981;background:#ecfdf5}
    .photo-drop-icon{font-size:36px;margin-bottom:6px}
    .photo-drop-text{font-size:13px;color:#64748b}
    .photo-drop-sub{font-size:11px;color:#94a3b8;margin-top:3px}
    .photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:14px}
    .photo-item{position:relative;border-radius:10px;overflow:hidden;background:#f1f5f9;aspect-ratio:4/3}
    .photo-item img{width:100%;height:100%;object-fit:cover}
    .photo-item .photo-delete{position:absolute;top:5px;right:5px;width:26px;height:26px;border-radius:50%;background:rgba(220,38,38,.9);color:white;border:none;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s}
    .photo-item:hover .photo-delete{opacity:1}
    .photo-item .photo-name{position:absolute;bottom:0;left:0;right:0;padding:3px 6px;background:rgba(0,0,0,.55);color:white;font-size:10px;text-align:center}
    .photo-msg{font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="/admin/parking/" class="sidebar-logo">
        <div class="logo-icon">P</div>
        ParkingMap
      </a>
    </div>
    <nav>
      <a href="/admin/parking/" class="active"><span class="nav-icon">ğŸ…¿ï¸</span> ì£¼ì°¨ì¥ ê´€ë¦¬</a>
      <a href="/admin/blog/"><span class="nav-icon">ğŸ“</span> ë¸”ë¡œê·¸ ê´€ë¦¬</a>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </aside>

  <div class="main">
    <div class="page-header">
      <div>
        <h1 id="pageTitle">ì£¼ì°¨ì¥ ê´€ë¦¬</h1>
        <p class="subtitle" id="pageSubtitle">ë°ì´í„° ë¡œë”© ì¤‘...</p>
      </div>
    </div>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="ì£¼ì°¨ì¥ ì´ë¦„ ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰..." />
      <select id="districtFilter">
        <option value="">ì „ì²´ êµ¬</option>
      </select>
      <select id="typeFilter">
        <option value="">ì „ì²´ ìœ í˜•</option>
        <option value="ê³µì˜">ê³µì˜</option>
        <option value="ë¯¼ì˜">ë¯¼ì˜</option>
      </select>
    </div>

    <div class="table-card">
      <div id="loadingState" class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
      <div id="emptyState" class="empty" style="display:none;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <table id="parkingTable" style="display:none;">
        <thead>
          <tr>
            <th>êµ¬</th>
            <th>ì£¼ì°¨ì¥</th>
            <th>ìœ í˜•</th>
            <th style="text-align:right;">ì£¼ì°¨ë©´ìˆ˜</th>
            <th style="width:130px;">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="parkingTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- í¸ì§‘ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">-</h2>
          <p class="header-sub" id="modalSubtitle"></p>
        </div>
        <button class="btn btn-gray" id="modalClose" style="padding:6px 12px;font-size:12px;">ë‹«ê¸°</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="form">ë°ì´í„° í¸ì§‘</button>
        <button class="modal-tab" data-tab="photos">ì‚¬ì§„ ê´€ë¦¬ <span class="tab-count" id="photoCount">0</span></button>
      </div>
      <div class="modal-body">
        <!-- ë°ì´í„° í¸ì§‘ íƒ­ (í¼) -->
        <div class="tab-panel active" id="tabForm">
          <div class="form-section">
            <div class="form-section-title"><span>ğŸ“Œ</span> ê¸°ë³¸ ì •ë³´</div>
            <div class="form-group">
              <label>ì£¼ì°¨ì¥ ì´ë¦„</label>
              <input type="text" id="f_name" />
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>ìœ í˜•</label>
                <select id="f_type"><option value="ê³µì˜">ê³µì˜</option><option value="ë¯¼ì˜">ë¯¼ì˜</option></select>
              </div>
              <div class="form-group">
                <label>ë¶„ë¥˜</label>
                <select id="f_category"><option value="ë…¸ìƒ">ë…¸ìƒ</option><option value="ë…¸ì™¸">ë…¸ì™¸</option><option value="ë¶€ì„¤">ë¶€ì„¤</option></select>
              </div>
              <div class="form-group">
                <label>ì´ ì£¼ì°¨ë©´ìˆ˜</label>
                <input type="number" id="f_totalSpaces" min="0" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ì „í™”ë²ˆí˜¸</label>
                <input type="text" id="f_phone" placeholder="02-000-0000" />
              </div>
              <div class="form-group">
                <label>ìŠ¬ëŸ¬ê·¸ (URL ê²½ë¡œ)</label>
                <input type="text" id="f_slug" placeholder="parking-slug" />
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title"><span>ğŸ“</span> ìœ„ì¹˜ ì •ë³´</div>
            <div class="form-group">
              <label>ì§€ë²ˆ ì£¼ì†Œ</label>
              <input type="text" id="f_address" />
            </div>
            <div class="form-group">
              <label>ë„ë¡œëª… ì£¼ì†Œ</label>
              <input type="text" id="f_roadAddress" />
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>ì‹œ/ë„</label>
                <input type="text" id="f_sido" readonly />
              </div>
              <div class="form-group">
                <label>ì‹œ/êµ°/êµ¬</label>
                <input type="text" id="f_sigungu" readonly />
              </div>
              <div class="form-group">
                <label>ì/ë©´/ë™</label>
                <input type="text" id="f_dong" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ìœ„ë„ (lat)</label>
                <input type="text" id="f_lat" />
              </div>
              <div class="form-group">
                <label>ê²½ë„ (lng)</label>
                <input type="text" id="f_lng" />
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title"><span>ğŸ•</span> ìš´ì˜ ì‹œê°„</div>
            <div class="form-group">
              <label>ìš´ì˜ ìš”ì¼</label>
              <input type="text" id="f_operatingDays" placeholder="í‰ì¼+í† ìš”ì¼+ê³µíœ´ì¼" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>í‰ì¼ ì‹œì‘</label>
                <input type="text" id="f_weekdayOpen" placeholder="09:00" />
              </div>
              <div class="form-group">
                <label>í‰ì¼ ì¢…ë£Œ</label>
                <input type="text" id="f_weekdayClose" placeholder="18:00" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ì£¼ë§ ì‹œì‘</label>
                <input type="text" id="f_weekendOpen" placeholder="09:00" />
              </div>
              <div class="form-group">
                <label>ì£¼ë§ ì¢…ë£Œ</label>
                <input type="text" id="f_weekendClose" placeholder="18:00" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ê³µíœ´ì¼ ì‹œì‘</label>
                <input type="text" id="f_holidayOpen" placeholder="09:00" />
              </div>
              <div class="form-group">
                <label>ê³µíœ´ì¼ ì¢…ë£Œ</label>
                <input type="text" id="f_holidayClose" placeholder="18:00" />
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title"><span>ğŸ’°</span> ìš”ê¸ˆ ì •ë³´</div>
            <div class="form-row-3">
              <div class="form-group">
                <label>ë¬´ë£Œ ì—¬ë¶€</label>
                <select id="f_isFree"><option value="N">ìœ ë£Œ (N)</option><option value="Y">ë¬´ë£Œ (Y)</option></select>
              </div>
              <div class="form-group">
                <label>ê¸°ë³¸ ì‹œê°„ (ë¶„)</label>
                <input type="text" id="f_basicTime" placeholder="30" />
              </div>
              <div class="form-group">
                <label>ê¸°ë³¸ ìš”ê¸ˆ (ì›)</label>
                <input type="text" id="f_basicCharge" placeholder="1000" />
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>ì¶”ê°€ ë‹¨ìœ„ (ë¶„)</label>
                <input type="text" id="f_addUnitTime" placeholder="10" />
              </div>
              <div class="form-group">
                <label>ì¶”ê°€ ìš”ê¸ˆ (ì›)</label>
                <input type="text" id="f_addUnitCharge" placeholder="500" />
              </div>
              <div class="form-group">
                <label>ì›” ì •ê¸°ê¶Œ (ì›)</label>
                <input type="text" id="f_monthlyPass" placeholder="100000" />
              </div>
            </div>
            <div class="form-group">
              <label>ìš”ê¸ˆ ì•ˆë‚´</label>
              <input type="text" id="f_feeInfo" placeholder="ìš”ê¸ˆ ê´€ë ¨ ì•ˆë‚´ ì‚¬í•­" />
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title"><span>ğŸ“</span> ì—ë””í„° ë©”ëª¨</div>
            <div class="form-group">
              <label>ì—ë””í„°ì˜ ì˜ê²¬</label>
              <textarea id="f_editorOpinion" placeholder="í˜„ì¥ ë°©ë¬¸ í›„ ëŠë‚€ ì , íŒ, íŠ¹ì´ì‚¬í•­ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
            </div>
            <div class="form-group">
              <label>ìµœì¢… ìˆ˜ì •ì¼</label>
              <input type="text" id="f_updatedAt" placeholder="2025-01-01" />
            </div>
          </div>

          <div class="msg msg-success" id="saveSuccess">ì €ì¥ ì™„ë£Œ!</div>
          <div class="msg msg-error" id="saveError"></div>
        </div>

        <!-- ì‚¬ì§„ ê´€ë¦¬ íƒ­ -->
        <div class="tab-panel" id="tabPhotos">
          <div class="photo-drop" id="photoDrop">
            <div class="photo-drop-icon">ğŸ“¸</div>
            <div class="photo-drop-text">ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
            <div class="photo-drop-sub">JPG, PNG, WebP â€” ìë™ìœ¼ë¡œ WebP ë³€í™˜ (ìµœëŒ€ 10ì¥)</div>
          </div>
          <input type="file" id="photoFileInput" accept="image/*" multiple style="display:none;" />
          <div class="msg msg-success photo-msg" id="photoSuccess"></div>
          <div class="msg msg-error photo-msg" id="photoError"></div>
          <div class="photo-grid" id="photoGrid"></div>
        </div>
      </div>
      <div class="modal-footer" id="formFooter">
        <button class="btn btn-gray" id="modalCloseFooter">ì·¨ì†Œ</button>
        <button class="btn btn-primary" id="saveFormBtn">GitHubì— ì €ì¥</button>
      </div>
    </div>
  </div>

  <script is:inline>
    const districts = [
      'ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬',
      'ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬',
      'ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬',
      'ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬',
      'ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬',
    ];

    // í¼ í•„ë“œ ë§¤í•‘
    const FORM_FIELDS = [
      'name','type','category','totalSpaces','phone','slug',
      'address','roadAddress','sido','sigungu','dong','lat','lng',
      'operatingDays','weekdayOpen','weekdayClose','weekendOpen','weekendClose','holidayOpen','holidayClose',
      'isFree','basicTime','basicCharge','addUnitTime','addUnitCharge','monthlyPass','feeInfo',
      'editorOpinion','updatedAt'
    ];

    let allParkingLots = [];
    let filteredParkingLots = [];
    let currentEditingParking = null;

    // â”€â”€â”€ ë°ì´í„° ë¡œë”© â”€â”€â”€
    async function loadAllParkingData() {
      try {
        const promises = districts.map(d =>
          fetch('/data/parking/ì„œìš¸íŠ¹ë³„ì‹œ/' + d + '.json')
            .then(res => res.json())
            .then(data => ({ district: d, items: data.items || [] }))
        );
        const results = await Promise.all(promises);

        allParkingLots = [];
        results.forEach(({ district, items }) => {
          items.forEach((parking, idx) => {
            allParkingLots.push({ district, parking, originalIndex: idx });
          });
        });

        document.getElementById('pageTitle').textContent = 'ì£¼ì°¨ì¥ ê´€ë¦¬';
        document.getElementById('pageSubtitle').textContent = 'ì´ ' + allParkingLots.length + 'ê°œ ì£¼ì°¨ì¥';

        const districtFilter = document.getElementById('districtFilter');
        districts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d; opt.textContent = d;
          districtFilter.appendChild(opt);
        });

        applyFilters();
      } catch (e) {
        document.getElementById('loadingState').innerHTML = '<div style="color:#dc2626;">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + e.message + '</div>';
      }
    }

    // â”€â”€â”€ í•„í„° â”€â”€â”€
    function applyFilters() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const dist = document.getElementById('districtFilter').value;
      const type = document.getElementById('typeFilter').value;

      filteredParkingLots = allParkingLots.filter(({ district, parking }) => {
        const matchSearch = !search ||
          parking.name.toLowerCase().includes(search) ||
          (parking.address || '').toLowerCase().includes(search) ||
          (parking.roadAddress || '').toLowerCase().includes(search);
        const matchDist = !dist || district === dist;
        const matchType = !type || parking.type === type;
        return matchSearch && matchDist && matchType;
      });

      renderTable();
    }

    // â”€â”€â”€ í…Œì´ë¸” ë Œë”ë§ â”€â”€â”€
    function renderTable() {
      const loadingEl = document.getElementById('loadingState');
      const emptyEl = document.getElementById('emptyState');
      const table = document.getElementById('parkingTable');
      const tbody = document.getElementById('parkingTableBody');

      loadingEl.style.display = 'none';

      if (filteredParkingLots.length === 0) {
        emptyEl.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      table.style.display = 'table';

      tbody.innerHTML = filteredParkingLots.map(({ district, parking, originalIndex }) => {
        const addr = parking.roadAddress || parking.address || '';
        const slug = parking.slug;
        const dong = parking.dong;
        const sido = parking.sido || 'ì„œìš¸íŠ¹ë³„ì‹œ';
        const sigungu = parking.sigungu || district;

        let viewBtn = '';
        if (slug && dong) {
          const viewUrl = '/' + encodeURIComponent(sido) + '/' + encodeURIComponent(sigungu) + '/' + encodeURIComponent(dong) + '/' + encodeURIComponent(slug) + '/';
          viewBtn = '<a href="' + viewUrl + '" target="_blank" class="btn btn-view" onclick="event.stopPropagation();">ë³´ê¸° â†—</a>';
        }

        return '<tr onclick="openEditor(\'' + district + '\',' + originalIndex + ')">' +
          '<td>' + district + '</td>' +
          '<td><div class="parking-name">' + parking.name + '</div><div class="parking-addr">' + addr + '</div></td>' +
          '<td><span class="badge badge-' + parking.type + '">' + parking.type + '</span></td>' +
          '<td style="text-align:right;">' + (parking.totalSpaces || 0) + 'ë©´</td>' +
          '<td><div class="td-actions"><button class="btn btn-primary" style="padding:4px 10px;font-size:11px;" onclick="event.stopPropagation();openEditor(\'' + district + '\',' + originalIndex + ')">í¸ì§‘</button>' + viewBtn + '</div></td>' +
        '</tr>';
      }).join('');
    }

    // â”€â”€â”€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ â”€â”€â”€
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('districtFilter').addEventListener('change', applyFilters);
    document.getElementById('typeFilter').addEventListener('change', applyFilters);

    // â”€â”€â”€ ëª¨ë‹¬ íƒ­ ì „í™˜ â”€â”€â”€
    document.querySelector('.modal-tabs').addEventListener('click', (e) => {
      const tab = e.target.closest('.modal-tab');
      if (!tab) return;
      const tabName = tab.dataset.tab;

      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(tabName === 'form' ? 'tabForm' : 'tabPhotos').classList.add('active');

      document.getElementById('formFooter').style.display = tabName === 'form' ? 'flex' : 'none';

      if (tabName === 'photos' && currentEditingParking) {
        loadPhotos();
      }
    });

    // â”€â”€â”€ ëª¨ë‹¬ ì—´ê¸° â”€â”€â”€
    window.openEditor = function(district, originalIndex) {
      const lot = allParkingLots.find(p => p.district === district && p.originalIndex === originalIndex);
      if (!lot) return;

      const parking = lot.parking;
      currentEditingParking = { district, parking, originalIndex };

      document.getElementById('modalTitle').textContent = parking.name;
      document.getElementById('modalSubtitle').textContent = district + ' Â· ' + (parking.roadAddress || parking.address || '');
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById('saveSuccess').style.display = 'none';
      document.getElementById('saveError').style.display = 'none';
      document.getElementById('photoSuccess').style.display = 'none';
      document.getElementById('photoError').style.display = 'none';

      // íƒ­ ì´ˆê¸°í™”
      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.modal-tab[data-tab="form"]').classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('tabForm').classList.add('active');
      document.getElementById('formFooter').style.display = 'flex';

      // ì‚¬ì§„ ê°œìˆ˜
      document.getElementById('photoCount').textContent = (parking.images || []).length;

      // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
      FORM_FIELDS.forEach(key => {
        const el = document.getElementById('f_' + key);
        if (!el) return;
        const val = parking[key];
        if (el.tagName === 'SELECT') {
          el.value = val || el.options[0].value;
        } else if (el.tagName === 'TEXTAREA') {
          el.value = val || '';
        } else {
          el.value = val != null ? val : '';
        }
      });

      // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ
      document.querySelector('.modal-body').scrollTop = 0;
    };

    // â”€â”€â”€ ëª¨ë‹¬ ë‹«ê¸° â”€â”€â”€
    function closeModal() {
      document.getElementById('modalOverlay').style.display = 'none';
    }
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalCloseFooter').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modalOverlay')) closeModal();
    });

    // â”€â”€â”€ í¼ ì €ì¥ â”€â”€â”€
    document.getElementById('saveFormBtn').addEventListener('click', async () => {
      if (!currentEditingParking) return;

      const btn = document.getElementById('saveFormBtn');
      const okMsg = document.getElementById('saveSuccess');
      const errMsg = document.getElementById('saveError');
      btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...';
      okMsg.style.display = 'none'; errMsg.style.display = 'none';

      // í¼ ê°’ ìˆ˜ì§‘ â†’ ê¸°ì¡´ parking ê°ì²´ì— ë¨¸ì§€
      const updated = Object.assign({}, currentEditingParking.parking);
      FORM_FIELDS.forEach(key => {
        const el = document.getElementById('f_' + key);
        if (!el) return;
        let val = el.value;

        // ìˆ«ì í•„ë“œ ë³€í™˜
        if (key === 'totalSpaces' || key === 'lat' || key === 'lng') {
          const num = Number(val);
          if (!isNaN(num) && val !== '') { val = num; }
          else if (val === '') { val = key === 'totalSpaces' ? 0 : updated[key]; }
        }

        updated[key] = val;
      });

      try {
        const { district, originalIndex } = currentEditingParking;

        // 1. ìµœì‹  district JSON ê°€ì ¸ì˜¤ê¸°
        const getRes = await fetch('/api/admin/parking/?district=' + encodeURIComponent(district));
        const getData = await getRes.json();
        if (!getRes.ok) throw new Error(getData.error || 'êµ¬ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');

        // 2. í•´ë‹¹ ì£¼ì°¨ì¥ ë°ì´í„° êµì²´
        const districtData = JSON.parse(getData.content);
        districtData.items[originalIndex] = updated;

        // 3. ì €ì¥
        const saveRes = await fetch('/api/admin/parking/', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            district,
            content: JSON.stringify(districtData, null, 2),
            sha: getData.sha,
          }),
        });

        const saveResult = await saveRes.json();

        if (saveRes.ok) {
          okMsg.textContent = 'ì €ì¥ ì™„ë£Œ! Vercel ìë™ ë°°í¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.';
          okMsg.style.display = 'block';

          // ë¡œì»¬ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
          const idx = allParkingLots.findIndex(p => p.district === district && p.originalIndex === originalIndex);
          if (idx !== -1) {
            allParkingLots[idx].parking = updated;
            currentEditingParking.parking = updated;
          }
          applyFilters();
        } else {
          errMsg.textContent = saveResult.error || 'ì €ì¥ ì‹¤íŒ¨';
          errMsg.style.display = 'block';
        }
      } catch (e) {
        errMsg.textContent = 'ì„œë²„ ì˜¤ë¥˜: ' + e.message;
        errMsg.style.display = 'block';
      } finally {
        btn.disabled = false; btn.textContent = 'GitHubì— ì €ì¥';
      }
    });

    // â”€â”€â”€ ì‚¬ì§„ ê´€ë¦¬ â”€â”€â”€
    let currentPhotos = [];

    async function loadPhotos() {
      const grid = document.getElementById('photoGrid');
      grid.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      const { district, parking } = currentEditingParking;
      const slug = parking.slug;

      if (!slug) {
        grid.innerHTML = '<div style="text-align:center;padding:20px;color:#dc2626;">ì´ ì£¼ì°¨ì¥ì— slugê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° í¸ì§‘ íƒ­ì—ì„œ slugë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.</div>';
        return;
      }

      try {
        const res = await fetch('/api/admin/parking-images/?district=' + encodeURIComponent(district) + '&slug=' + encodeURIComponent(slug));
        const data = await res.json();
        currentPhotos = data.images || [];
        document.getElementById('photoCount').textContent = currentPhotos.length;
        renderPhotos();
      } catch (e) {
        grid.innerHTML = '<div style="text-align:center;padding:20px;color:#dc2626;">ë¡œë”© ì‹¤íŒ¨: ' + e.message + '</div>';
      }
    }

    function renderPhotos() {
      const grid = document.getElementById('photoGrid');
      if (currentPhotos.length === 0) {
        grid.innerHTML = '<div style="text-align:center;padding:24px;color:#94a3b8;font-size:13px;">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      grid.innerHTML = currentPhotos.map((photo, i) =>
        '<div class="photo-item" data-index="' + i + '">' +
          '<img src="' + photo.url + '" alt="' + photo.name + '" loading="lazy" />' +
          '<button class="photo-delete" onclick="deletePhoto(' + i + ')" title="ì‚­ì œ">Ã—</button>' +
          '<div class="photo-name">' + photo.name + '</div>' +
        '</div>'
      ).join('');
    }

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    const dropZone = document.getElementById('photoDrop');
    const fileInput = document.getElementById('photoFileInput');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); fileInput.value = ''; });

    async function handleFiles(files) {
      if (!currentEditingParking) return;
      const { district, parking, originalIndex } = currentEditingParking;
      const slug = parking.slug;

      if (!slug) { showPhotoError('slugê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° í¸ì§‘ íƒ­ì—ì„œ ì„¤ì •í•˜ì„¸ìš”.'); return; }

      const remaining = 10 - currentPhotos.length;
      const filesToProcess = Array.from(files).slice(0, remaining);
      if (filesToProcess.length === 0) { showPhotoError('ìµœëŒ€ 10ì¥ê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }

      showPhotoSuccess(filesToProcess.length + 'ì¥ ì—…ë¡œë“œ ì¤‘...');

      for (const file of filesToProcess) {
        try {
          const base64 = await convertToWebP(file);
          const nextNum = getNextFileName();
          const fileName = nextNum + '.webp';

          const res = await fetch('/api/admin/parking-images/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ district, slug, fileName, base64Data: base64, originalIndex }),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.error);
          showPhotoSuccess(fileName + ' ì—…ë¡œë“œ ì™„ë£Œ!');
        } catch (e) { showPhotoError('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message); }
      }

      await loadPhotos();
      showPhotoSuccess('ëª¨ë“  ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ!');
    }

    function getNextFileName() {
      const nums = currentPhotos.map(p => parseInt(p.name.replace('.webp', ''), 10)).filter(n => !isNaN(n));
      let next = 1;
      while (nums.includes(next)) next++;
      return String(next).padStart(2, '0');
    }

    function convertToWebP(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxSize = 1200;
            let w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
              if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
              else { w = Math.round(w * maxSize / h); h = maxSize; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/webp', 0.8).split(',')[1]);
          };
          img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsDataURL(file);
      });
    }

    window.deletePhoto = async function(index) {
      const photo = currentPhotos[index];
      if (!photo || !confirm('"' + photo.name + '" ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const { district, parking, originalIndex } = currentEditingParking;
      try {
        const res = await fetch('/api/admin/parking-images/', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ district, slug: parking.slug, fileName: photo.name, sha: photo.sha, originalIndex }),
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.error);
        showPhotoSuccess(photo.name + ' ì‚­ì œ ì™„ë£Œ!');
        await loadPhotos();
      } catch (e) { showPhotoError('ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
    };

    function showPhotoSuccess(msg) {
      const el = document.getElementById('photoSuccess');
      el.textContent = msg; el.style.display = 'block';
      document.getElementById('photoError').style.display = 'none';
    }
    function showPhotoError(msg) {
      const el = document.getElementById('photoError');
      el.textContent = msg; el.style.display = 'block';
      document.getElementById('photoSuccess').style.display = 'none';
    }

    // â”€â”€â”€ ë¡œê·¸ì•„ì›ƒ â”€â”€â”€
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/auth/logout/', { method: 'POST' });
      window.location.href = '/admin/login/';
    });

    // í˜ì´ì§€ ë¡œë“œ
    loadAllParkingData();
  </script>
</body>
</html>
