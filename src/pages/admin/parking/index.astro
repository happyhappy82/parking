---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>ì£¼ì°¨ì¥ ê´€ë¦¬ | ParkingMap Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #111; }
    .sidebar {
      position: fixed; top: 0; left: 0; width: 240px; height: 100vh;
      background: #1a1a2e; color: white; padding: 24px 0;
    }
    .sidebar .logo { padding: 0 24px; font-size: 20px; font-weight: 800; margin-bottom: 32px; }
    .sidebar .logo span { color: #34d399; }
    .sidebar nav a {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 24px; color: #aaa; text-decoration: none;
      font-size: 14px; transition: all 0.2s;
    }
    .sidebar nav a:hover, .sidebar nav a.active { color: white; background: rgba(255,255,255,0.08); }
    .sidebar nav a.active { border-left: 3px solid #34d399; }
    .main { margin-left: 240px; padding: 32px 40px; }
    .header { margin-bottom: 24px; }
    .header h1 { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
    .header p { font-size: 14px; color: #888; }

    /* ê²€ìƒ‰ & í•„í„° ì„¹ì…˜ */
    .controls {
      background: white; border-radius: 12px; padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 20px;
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
    }
    .controls input[type="text"] {
      flex: 1; min-width: 200px; padding: 10px 14px;
      border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
      outline: none;
    }
    .controls input[type="text"]:focus { border-color: #059669; }
    .controls select {
      padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 14px; outline: none; cursor: pointer;
      background: white;
    }
    .controls select:focus { border-color: #059669; }

    /* í…Œì´ë¸” */
    .table-container {
      background: white; border-radius: 12px; overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    table {
      width: 100%; border-collapse: collapse; font-size: 14px;
    }
    thead { background: #f9fafb; border-bottom: 2px solid #e5e7eb; }
    th {
      text-align: left; padding: 14px 16px; font-weight: 700;
      font-size: 13px; color: #374151; text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    tbody tr {
      border-bottom: 1px solid #f3f4f6; cursor: pointer;
      transition: background 0.15s;
    }
    tbody tr:hover { background: #f9fafb; }
    tbody tr:last-child { border-bottom: none; }
    td { padding: 14px 16px; color: #111; }
    .type-badge {
      display: inline-block; padding: 3px 8px; border-radius: 4px;
      font-size: 11px; font-weight: 600;
    }
    .type-ê³µì˜ { background: #d1fae5; color: #065f46; }
    .type-ë¯¼ì˜ { background: #dbeafe; color: #1e40af; }
    .loading {
      text-align: center; padding: 60px 20px; color: #888;
    }
    .empty {
      text-align: center; padding: 60px 20px; color: #888;
    }

    /* Editor modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 100;
    }
    .modal {
      position: fixed; top: 5%; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 800px; max-height: 90vh;
      background: white; border-radius: 16px; z-index: 101;
      display: flex; flex-direction: column;
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h2 { font-size: 18px; font-weight: 700; }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-body textarea {
      width: 100%; min-height: 400px; border: 1px solid #ddd; border-radius: 8px;
      padding: 16px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px;
      line-height: 1.5; outline: none; resize: vertical;
    }
    .modal-body textarea:focus { border-color: #059669; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid #eee; display: flex; gap: 12px; justify-content: flex-end; }
    .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #059669; color: white; }
    .btn-primary:hover { background: #047857; }
    .btn-gray { background: #e5e7eb; color: #374151; }
    .btn-gray:hover { background: #d1d5db; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-red { background: #fee2e2; color: #dc2626; }
    .btn-red:hover { background: #fecaca; }
    .msg { padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-top: 12px; display: none; }
    .msg-success { background: #d1fae5; color: #065f46; }
    .msg-error { background: #fee2e2; color: #dc2626; }

    /* ëª¨ë‹¬ íƒ­ */
    .modal-tabs {
      display: flex; gap: 0; border-bottom: 2px solid #e5e7eb;
      padding: 0 24px; background: #f9fafb;
    }
    .modal-tab {
      padding: 12px 20px; border: none; background: none;
      font-size: 14px; font-weight: 600; color: #6b7280;
      cursor: pointer; position: relative; transition: color 0.15s;
    }
    .modal-tab:hover { color: #111; }
    .modal-tab.active {
      color: #059669;
    }
    .modal-tab.active::after {
      content: ''; position: absolute; bottom: -2px; left: 0; right: 0;
      height: 2px; background: #059669;
    }
    .modal-tab .tab-count {
      display: inline-block; margin-left: 6px; padding: 1px 7px;
      border-radius: 10px; font-size: 11px; font-weight: 700;
      background: #e5e7eb; color: #6b7280;
    }
    .modal-tab.active .tab-count { background: #d1fae5; color: #059669; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ì‚¬ì§„ ê´€ë¦¬ */
    .photo-drop {
      border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px 20px;
      text-align: center; cursor: pointer; transition: all 0.2s;
      background: #fafafa; margin-bottom: 16px;
    }
    .photo-drop:hover, .photo-drop.dragover {
      border-color: #059669; background: #ecfdf5;
    }
    .photo-drop-icon { font-size: 40px; margin-bottom: 8px; }
    .photo-drop-text { font-size: 14px; color: #6b7280; }
    .photo-drop-sub { font-size: 12px; color: #9ca3af; margin-top: 4px; }
    .photo-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px; margin-top: 16px;
    }
    .photo-item {
      position: relative; border-radius: 10px; overflow: hidden;
      background: #f3f4f6; aspect-ratio: 4/3;
    }
    .photo-item img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .photo-item .photo-delete {
      position: absolute; top: 6px; right: 6px;
      width: 28px; height: 28px; border-radius: 50%;
      background: rgba(220,38,38,0.9); color: white;
      border: none; cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.15s;
    }
    .photo-item:hover .photo-delete { opacity: 1; }
    .photo-item .photo-name {
      position: absolute; bottom: 0; left: 0; right: 0;
      padding: 4px 8px; background: rgba(0,0,0,0.6);
      color: white; font-size: 11px; text-align: center;
    }
    .photo-uploading {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8); display: flex;
      align-items: center; justify-content: center;
      font-size: 13px; font-weight: 600; color: #059669;
    }
    .photo-msg { font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo"><span>P</span> Admin</div>
    <nav>
      <a href="/admin/">ëŒ€ì‹œë³´ë“œ</a>
      <a href="/admin/blog/">ë¸”ë¡œê·¸ ê´€ë¦¬</a>
      <a href="/admin/parking/" class="active">ì£¼ì°¨ì¥ ê´€ë¦¬</a>
      <a href="/" target="_blank">ì‚¬ì´íŠ¸ ë³´ê¸°</a>
    </nav>
  </aside>

  <div class="main">
    <div class="header">
      <h1 id="pageTitle">ì£¼ì°¨ì¥ ë°ì´í„° ê´€ë¦¬</h1>
      <p>ê°œë³„ ì£¼ì°¨ì¥ì„ ê²€ìƒ‰í•˜ê³  í¸ì§‘í•©ë‹ˆë‹¤. ì €ì¥ ì‹œ GitHubì— ì»¤ë°‹ â†’ Vercel ìë™ ë°°í¬ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="controls">
      <input
        type="text"
        id="searchInput"
        placeholder="ì£¼ì°¨ì¥ ì´ë¦„ ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰..."
      />
      <select id="districtFilter">
        <option value="">ì „ì²´ êµ¬</option>
      </select>
      <select id="typeFilter">
        <option value="">ì „ì²´ ìœ í˜•</option>
        <option value="ê³µì˜">ê³µì˜</option>
        <option value="ë¯¼ì˜">ë¯¼ì˜</option>
      </select>
    </div>

    <div class="table-container">
      <div id="loadingState" class="loading">
        <div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
      </div>
      <div id="emptyState" class="empty" style="display: none;">
        ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
      <table id="parkingTable" style="display: none;">
        <thead>
          <tr>
            <th>êµ¬</th>
            <th>ì´ë¦„</th>
            <th>ìœ í˜•</th>
            <th>ì£¼ì†Œ</th>
            <th style="text-align: right;">ì£¼ì°¨ë©´ìˆ˜</th>
          </tr>
        </thead>
        <tbody id="parkingTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- í¸ì§‘ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">-</h2>
        <button class="btn btn-gray" id="modalClose" style="padding:6px 12px;">ë‹«ê¸°</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="json">ë°ì´í„° í¸ì§‘</button>
        <button class="modal-tab" data-tab="photos">ì‚¬ì§„ ê´€ë¦¬ <span class="tab-count" id="photoCount">0</span></button>
      </div>
      <div class="modal-body">
        <!-- ë°ì´í„° í¸ì§‘ íƒ­ -->
        <div class="tab-panel active" id="tabJson">
          <textarea id="jsonEditor" spellcheck="false"></textarea>
          <div class="msg msg-success" id="saveSuccess">ì €ì¥ ì™„ë£Œ!</div>
          <div class="msg msg-error" id="saveError"></div>
        </div>
        <!-- ì‚¬ì§„ ê´€ë¦¬ íƒ­ -->
        <div class="tab-panel" id="tabPhotos">
          <div class="photo-drop" id="photoDrop">
            <div class="photo-drop-icon">ğŸ“¸</div>
            <div class="photo-drop-text">ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
            <div class="photo-drop-sub">JPG, PNG, WebP â€” ìë™ìœ¼ë¡œ WebP ë³€í™˜ (ìµœëŒ€ 10ì¥)</div>
          </div>
          <input type="file" id="photoFileInput" accept="image/*" multiple style="display:none;" />
          <div class="msg msg-success photo-msg" id="photoSuccess"></div>
          <div class="msg msg-error photo-msg" id="photoError"></div>
          <div class="photo-grid" id="photoGrid"></div>
        </div>
      </div>
      <div class="modal-footer" id="jsonFooter">
        <button class="btn btn-gray" id="formatBtn">JSON ì •ë ¬</button>
        <button class="btn btn-primary" id="saveJsonBtn">GitHubì— ì €ì¥</button>
      </div>
    </div>
  </div>

  <script is:inline>
    const districts = [
      'ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬',
      'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬',
      'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬',
      'ì„±ë™êµ¬', 'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬',
      'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬',
    ];

    let allParkingLots = []; // { district, parking, originalIndex }
    let filteredParkingLots = [];
    let currentEditingParking = null;

    // ì´ˆê¸° ë¡œë”©
    async function loadAllParkingData() {
      try {
        const promises = districts.map(d =>
          fetch(`/data/parking/ì„œìš¸íŠ¹ë³„ì‹œ/${d}.json`)
            .then(res => res.json())
            .then(data => ({
              district: d,
              items: data.items || []
            }))
        );

        const results = await Promise.all(promises);

        allParkingLots = [];
        results.forEach(({ district, items }) => {
          items.forEach((parking, idx) => {
            allParkingLots.push({
              district,
              parking,
              originalIndex: idx
            });
          });
        });

        // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
        document.getElementById('pageTitle').textContent = `ì£¼ì°¨ì¥ ë°ì´í„° ê´€ë¦¬ (${allParkingLots.length}ê°œ)`;

        // êµ¬ í•„í„° ì±„ìš°ê¸°
        const districtFilter = document.getElementById('districtFilter');
        districts.forEach(d => {
          const option = document.createElement('option');
          option.value = d;
          option.textContent = d;
          districtFilter.appendChild(option);
        });

        // ì´ˆê¸° ë Œë”ë§
        applyFilters();

      } catch (e) {
        console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', e);
        document.getElementById('loadingState').innerHTML = `<div style="color: #dc2626;">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${e.message}</div>`;
      }
    }

    // í•„í„° ì ìš©
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const districtFilter = document.getElementById('districtFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;

      filteredParkingLots = allParkingLots.filter(({ district, parking }) => {
        // ê²€ìƒ‰ì–´ í•„í„°
        const matchesSearch = !searchTerm ||
          parking.name.toLowerCase().includes(searchTerm) ||
          (parking.address || '').toLowerCase().includes(searchTerm) ||
          (parking.roadAddress || '').toLowerCase().includes(searchTerm);

        // êµ¬ í•„í„°
        const matchesDistrict = !districtFilter || district === districtFilter;

        // ìœ í˜• í•„í„°
        const matchesType = !typeFilter || parking.type === typeFilter;

        return matchesSearch && matchesDistrict && matchesType;
      });

      renderTable();
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const table = document.getElementById('parkingTable');
      const tbody = document.getElementById('parkingTableBody');

      loadingState.style.display = 'none';

      if (filteredParkingLots.length === 0) {
        emptyState.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      table.style.display = 'table';

      tbody.innerHTML = '';
      filteredParkingLots.forEach(({ district, parking, originalIndex }) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${district}</td>
          <td><strong>${parking.name}</strong></td>
          <td><span class="type-badge type-${parking.type}">${parking.type}</span></td>
          <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${parking.roadAddress || parking.address}</td>
          <td style="text-align: right;">${parking.totalSpaces || 0}ë©´</td>
        `;
        tr.addEventListener('click', () => openEditor(district, parking, originalIndex));
        tbody.appendChild(tr);
      });
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('districtFilter').addEventListener('change', applyFilters);
    document.getElementById('typeFilter').addEventListener('change', applyFilters);

    // â”€â”€â”€ ëª¨ë‹¬ íƒ­ ì „í™˜ â”€â”€â”€
    document.querySelector('.modal-tabs').addEventListener('click', (e) => {
      const tab = e.target.closest('.modal-tab');
      if (!tab) return;
      const tabName = tab.dataset.tab;

      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(tabName === 'json' ? 'tabJson' : 'tabPhotos').classList.add('active');

      // í’‹í„° í‘œì‹œ/ìˆ¨ê¸°ê¸° (ì‚¬ì§„ íƒ­ì—ì„  í’‹í„° ìˆ¨ê¹€)
      document.getElementById('jsonFooter').style.display = tabName === 'json' ? 'flex' : 'none';

      // ì‚¬ì§„ íƒ­ ì—´ë©´ ì´ë¯¸ì§€ ë¡œë“œ
      if (tabName === 'photos' && currentEditingParking) {
        loadPhotos();
      }
    });

    // í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
    async function openEditor(district, parking, originalIndex) {
      currentEditingParking = { district, parking, originalIndex };

      document.getElementById('modalTitle').textContent = `${parking.name} (${district})`;
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById('jsonEditor').value = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      document.getElementById('saveSuccess').style.display = 'none';
      document.getElementById('saveError').style.display = 'none';
      document.getElementById('photoSuccess').style.display = 'none';
      document.getElementById('photoError').style.display = 'none';

      // íƒ­ ì´ˆê¸°í™” (í•­ìƒ ë°ì´í„° í¸ì§‘ íƒ­ìœ¼ë¡œ)
      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.modal-tab[data-tab="json"]').classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('tabJson').classList.add('active');
      document.getElementById('jsonFooter').style.display = 'flex';

      // ì‚¬ì§„ ê°œìˆ˜ í‘œì‹œ
      const imgCount = (parking.images || []).length;
      document.getElementById('photoCount').textContent = imgCount;

      // ê°œë³„ ì£¼ì°¨ì¥ JSON í‘œì‹œ
      try {
        const formatted = JSON.stringify(parking, null, 2);
        document.getElementById('jsonEditor').value = formatted;
      } catch (e) {
        document.getElementById('jsonEditor').value = '// JSON ë³€í™˜ ì˜¤ë¥˜: ' + e.message;
      }
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('modalClose').addEventListener('click', () => {
      document.getElementById('modalOverlay').style.display = 'none';
    });

    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modalOverlay')) {
        document.getElementById('modalOverlay').style.display = 'none';
      }
    });

    // â”€â”€â”€ ì‚¬ì§„ ê´€ë¦¬ â”€â”€â”€
    let currentPhotos = []; // { name, path, sha, url }

    async function loadPhotos() {
      const grid = document.getElementById('photoGrid');
      grid.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      const { district, parking } = currentEditingParking;
      const slug = parking.slug;

      if (!slug) {
        grid.innerHTML = '<div style="text-align:center;padding:20px;color:#dc2626;">ì´ ì£¼ì°¨ì¥ì— slugê°€ ì—†ìŠµë‹ˆë‹¤. JSONì—ì„œ slugë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.</div>';
        return;
      }

      try {
        const res = await fetch(`/api/admin/parking-images/?district=${encodeURIComponent(district)}&slug=${encodeURIComponent(slug)}`);
        const data = await res.json();
        currentPhotos = data.images || [];
        document.getElementById('photoCount').textContent = currentPhotos.length;
        renderPhotos();
      } catch (e) {
        grid.innerHTML = `<div style="text-align:center;padding:20px;color:#dc2626;">ë¡œë”© ì‹¤íŒ¨: ${e.message}</div>`;
      }
    }

    function renderPhotos() {
      const grid = document.getElementById('photoGrid');

      if (currentPhotos.length === 0) {
        grid.innerHTML = '<div style="text-align:center;padding:30px;color:#9ca3af;font-size:14px;">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      grid.innerHTML = currentPhotos.map((photo, i) => `
        <div class="photo-item" data-index="${i}">
          <img src="${photo.url}" alt="${photo.name}" loading="lazy" />
          <button class="photo-delete" onclick="deletePhoto(${i})" title="ì‚­ì œ">Ã—</button>
          <div class="photo-name">${photo.name}</div>
        </div>
      `).join('');
    }

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    const dropZone = document.getElementById('photoDrop');
    const fileInput = document.getElementById('photoFileInput');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
      fileInput.value = '';
    });

    async function handleFiles(files) {
      if (!currentEditingParking) return;

      const { district, parking, originalIndex } = currentEditingParking;
      const slug = parking.slug;

      if (!slug) {
        showPhotoError('ì´ ì£¼ì°¨ì¥ì— slugê°€ ì—†ìŠµë‹ˆë‹¤. JSONì—ì„œ slugë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.');
        return;
      }

      const maxPhotos = 10;
      const remaining = maxPhotos - currentPhotos.length;
      const filesToProcess = Array.from(files).slice(0, remaining);

      if (filesToProcess.length === 0) {
        showPhotoError('ìµœëŒ€ 10ì¥ê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      showPhotoSuccess(`${filesToProcess.length}ì¥ ì—…ë¡œë“œ ì¤‘...`);

      for (const file of filesToProcess) {
        try {
          // 1. WebPë¡œ ë³€í™˜
          const base64 = await convertToWebP(file);

          // 2. íŒŒì¼ëª… ìƒì„± (01.webp ~ 10.webp)
          const nextNum = getNextFileName();
          const fileName = nextNum + '.webp';

          // 3. ì—…ë¡œë“œ
          const res = await fetch('/api/admin/parking-images/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              district,
              slug,
              fileName,
              base64Data: base64,
              originalIndex,
            }),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.error);

          showPhotoSuccess(`${fileName} ì—…ë¡œë“œ ì™„ë£Œ!`);
        } catch (e) {
          showPhotoError(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
        }
      }

      // ì—…ë¡œë“œ í›„ ìƒˆë¡œê³ ì¹¨
      await loadPhotos();
      showPhotoSuccess('ëª¨ë“  ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ!');
    }

    function getNextFileName() {
      const existingNums = currentPhotos
        .map(p => parseInt(p.name.replace('.webp', ''), 10))
        .filter(n => !isNaN(n));

      let next = 1;
      while (existingNums.includes(next)) next++;
      return String(next).padStart(2, '0');
    }

    // Canvas APIë¡œ WebP ë³€í™˜
    function convertToWebP(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = (e) => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            // ìµœëŒ€ 1200px ë¦¬ì‚¬ì´ì¦ˆ
            const maxSize = 1200;
            let w = img.width;
            let h = img.height;

            if (w > maxSize || h > maxSize) {
              if (w > h) {
                h = Math.round(h * maxSize / w);
                w = maxSize;
              } else {
                w = Math.round(w * maxSize / h);
                h = maxSize;
              }
            }

            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);

            // WebPë¡œ ë³€í™˜ (í’ˆì§ˆ 80%)
            const dataUrl = canvas.toDataURL('image/webp', 0.8);
            // data:image/webp;base64, ë¶€ë¶„ ì œê±°
            const base64 = dataUrl.split(',')[1];
            resolve(base64);
          };

          img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
          img.src = e.target.result;
        };

        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsDataURL(file);
      });
    }

    // ì‚¬ì§„ ì‚­ì œ
    async function deletePhoto(index) {
      const photo = currentPhotos[index];
      if (!photo) return;
      if (!confirm(`"${photo.name}" ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      const { district, parking, originalIndex } = currentEditingParking;

      try {
        const res = await fetch('/api/admin/parking-images/', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            district,
            slug: parking.slug,
            fileName: photo.name,
            sha: photo.sha,
            originalIndex,
          }),
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error);

        showPhotoSuccess(`${photo.name} ì‚­ì œ ì™„ë£Œ!`);
        await loadPhotos();
      } catch (e) {
        showPhotoError(`ì‚­ì œ ì‹¤íŒ¨: ${e.message}`);
      }
    }

    function showPhotoSuccess(msg) {
      const el = document.getElementById('photoSuccess');
      el.textContent = msg;
      el.style.display = 'block';
      document.getElementById('photoError').style.display = 'none';
    }

    function showPhotoError(msg) {
      const el = document.getElementById('photoError');
      el.textContent = msg;
      el.style.display = 'block';
      document.getElementById('photoSuccess').style.display = 'none';
    }

    // JSON ì •ë ¬
    document.getElementById('formatBtn').addEventListener('click', () => {
      const editor = document.getElementById('jsonEditor');
      try {
        const parsed = JSON.parse(editor.value);
        editor.value = JSON.stringify(parsed, null, 2);
      } catch (e) {
        alert('JSON í˜•ì‹ ì˜¤ë¥˜: ' + e.message);
      }
    });

    // ì €ì¥
    document.getElementById('saveJsonBtn').addEventListener('click', async () => {
      if (!currentEditingParking) return;

      const btn = document.getElementById('saveJsonBtn');
      const successMsg = document.getElementById('saveSuccess');
      const errorMsg = document.getElementById('saveError');

      btn.disabled = true;
      btn.textContent = 'ì €ì¥ ì¤‘...';
      successMsg.style.display = 'none';
      errorMsg.style.display = 'none';

      // JSON ìœ íš¨ì„± ê²€ì‚¬
      const content = document.getElementById('jsonEditor').value;
      let updatedParkingData;
      try {
        updatedParkingData = JSON.parse(content);
      } catch {
        errorMsg.textContent = 'JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        errorMsg.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'GitHubì— ì €ì¥';
        return;
      }

      try {
        const { district, originalIndex } = currentEditingParking;

        // 1. GitHub APIë¡œ ìµœì‹  district JSON ê°€ì ¸ì˜¤ê¸°
        const getRes = await fetch(`/api/admin/parking/?district=${encodeURIComponent(district)}`);
        const getData = await getRes.json();

        if (!getRes.ok) {
          throw new Error(getData.error || 'êµ¬ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
        }

        // 2. íŒŒì‹± & í•´ë‹¹ ì£¼ì°¨ì¥ ë°ì´í„° êµì²´
        const districtData = JSON.parse(getData.content);
        districtData.items[originalIndex] = updatedParkingData;

        // 3. GitHub APIë¡œ ì €ì¥
        const saveRes = await fetch('/api/admin/parking/', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            district,
            content: JSON.stringify(districtData, null, 2),
            sha: getData.sha,
          }),
        });

        const saveResult = await saveRes.json();

        if (saveRes.ok) {
          successMsg.style.display = 'block';

          // ë¡œì»¬ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
          const parkingLotIndex = allParkingLots.findIndex(
            p => p.district === district && p.originalIndex === originalIndex
          );
          if (parkingLotIndex !== -1) {
            allParkingLots[parkingLotIndex].parking = updatedParkingData;
          }
          applyFilters();
        } else {
          errorMsg.textContent = saveResult.error || 'ì €ì¥ ì‹¤íŒ¨';
          errorMsg.style.display = 'block';
        }
      } catch (e) {
        errorMsg.textContent = 'ì„œë²„ ì˜¤ë¥˜: ' + e.message;
        errorMsg.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'GitHubì— ì €ì¥';
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë”©
    loadAllParkingData();
  </script>
</body>
</html>
